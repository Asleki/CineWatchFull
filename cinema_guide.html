<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CineWatch - Cinema Guide</title>

  <!-- Font Awesome CDN for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Inter Font (for consistent typography across the site) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght=300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Consolidated Main Stylesheet - Copied from index.html for consistent colors -->
  <style>
    /* Root Theme Variables - Copied from index.html */
    :root {
      --bg: #fff;
      --text: #111;
      --header-bg: #f0ecec;
      --search-bg: #f4f4f4;
      --card-border: #eee;
      --card-shadow: rgba(0, 0, 0, 0.05);
      --highlight: #007bff;
      --accent: #28a745;
      --danger: #dc3545;
      --info: #17a2b8;
      --warning: #ffc107;
      --modal-bg: rgba(0, 0, 0, 0.5);
      --modal-content-bg: #fff;
      --modal-text: #111;
      --search-area-height: 120px;

      /* New Variables for Homepage Content */
      --hero-overlay: rgba(0, 0, 0, 0.6);
      --section-padding: 40px 20px;
      --carousel-gap: 20px;
      --card-bg: #fff;
      --card-text: #111;
      --card-rating-bg: var(--accent);
      --card-rating-text: #fff;
      --button-hover: #0056b3;

      /* Search Suggestions */
      --suggestions-bg: #fff;
      --suggestions-border: #ddd;
      --suggestions-item-hover-bg: #f0f0f0;

      /* Carousel Specific */
      --carousel-arrow-bg: rgba(0, 0, 0, 0.5);
      --carousel-arrow-color: #fff;
      --carousel-arrow-hover-bg: rgba(0, 0, 0, 0.7);

      /* Specific for cinema guide (retained from old, can be adjusted) */
      --primary-button: #e50914; /* Netflix red */
      --primary-button-hover: #a0070e;
      --secondary-button: #6c757d;
      --secondary-button-hover: #5a6268;
      --step-active: var(--highlight);
      --step-complete: #28a745;
      --step-inactive: #ccc;
    }

    /* Dark Mode Variables - Copied from index.html */
    body.dark-mode {
      --bg: #1a1a1a;
      --text: #f0f0f0;
      --header-bg: #2a2a2a;
      --search-bg: #333;
      --card-border: #444;
      --card-shadow: rgba(0, 0, 0, 0.3);
      --highlight: #66b3ff;
      --accent: #4CAF50;
      --danger: #ff6b6b;
      --info: #00bcd4;
      --warning: #ffeb3b;
      --modal-bg: rgba(0, 0, 0, 0.7);
      --modal-content-bg: #282828;
      --modal-text: #f0f0f0;

      /* Dark Mode for New Homepage Content */
      --hero-overlay: rgba(0, 0, 0, 0.75);
      --card-bg: #282828;
      --card-text: #f0f0f0;
      --card-rating-bg: var(--accent);
      --card-rating-text: #fff;
      --button-hover: #4a90d9;

      /* Search Suggestions Dark Mode */
      --suggestions-bg: #282828;
      --suggestions-border: #444;
      --suggestions-item-hover-bg: #3a3a3a;

      /* Carousel Specific Dark Mode */
      --carousel-arrow-bg: rgba(255, 255, 255, 0.2);
      --carousel-arrow-color: #f0f0f0;
      --carousel-arrow-hover-bg: rgba(255, 255, 255, 0.3);

      /* Specific for cinema guide in dark mode */
      --primary-button: #e50914;
      --primary-button-hover: #a0070e;
      --secondary-button: #8d959c;
      --secondary-button-hover: #4fa5f1;
      --step-active: var(--highlight);
      --step-complete: #28a745;
      --step-inactive: #555;
    }

    /* Global Styles */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    a {
      color: var(--highlight);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    a:hover {
      color: var(--accent);
    }

    /* Accessibility: Focus styles */
    :focus-visible {
      outline: 2px solid var(--highlight);
      outline-offset: 2px;
    }

    /* Global Header Wrapper */
    .main-global-header {
      background-color: var(--header-bg);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      transition: background-color 0.3s, box-shadow 0.3s;
    }

    /* Utility Header (Top Row) */
    .utility-header {
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--card-border);
    }

    .logo a {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--highlight);
      text-transform: capitalize;
      letter-spacing: 1px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .header-utility-actions {
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .search-bar-toggle button {
        background: none;
        border: none;
        color: var(--text);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: background-color 0.2s ease;
    }

    .search-bar-toggle button:hover {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .account-menu {
      position: relative;
    }

    .account-button {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .account-button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .theme-toggle-button {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle-button:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }

    .account-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      background-color: var(--header-bg);
      border: 1px solid var(--card-border);
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      min-width: 180px;
      padding: 10px 0;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
    }

    .account-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .account-dropdown a {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      color: var(--text);
      font-size: 0.95rem;
      white-space: nowrap;
      transition: background-color 0.2s ease, color 0.2s ease;
    }

    .account-dropdown a:hover {
      background-color: rgba(0, 0, 0, 0.05);
      color: var(--highlight);
    }

    .account-dropdown a i {
      width: 20px;
      text-align: center;
    }

    /* Mobile Menu Toggle - default state is hidden */
    .mobile-menu-toggle {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.5rem;
      cursor: pointer;
      display: none;
    }

    /* Main Navigation Header (Desktop Only) */
    .main-nav-header {
      padding: 10px 20px;
      display: flex;
      justify-content: center;
      gap: 30px;
      align-items: center;
    }

    /* Mobile Navigation Menu (Hidden by default, shown by JS toggle) */
    .mobile-nav-links {
      flex-direction: column;
      background-color: var(--header-bg);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 10px 20px;
      border-bottom: 1px solid var(--card-border);
      display: none;
    }

    /* Dynamic Search Area */
    .dynamic-search-area {
      background-color: var(--header-bg);
      padding: 15px 20px;
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transition: max-height 0.4s ease-out, opacity 0.4s ease-out;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .dynamic-search-area.show {
      max-height: var(--search-area-height);
      opacity: 1;
    }

    .search-input-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1050;
    }

    .dynamic-search-area input[type="text"] {
      flex-grow: 1;
      padding: 10px 15px;
      border: 1px solid var(--card-border);
      border-radius: 25px;
      background-color: var(--search-bg);
      color: var(--text);
      font-size: 1rem;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    .dynamic-search-area input[type="text"]:focus {
      border-color: var(--highlight);
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
      outline: none;
    }

    .search-icon-btn {
      background: none;
      border: none;
      color: var(--text);
      font-size: 1.2rem;
      cursor: pointer;
      padding: 5px;
      transition: color 0.2s ease;
    }
    .search-icon-btn:hover {
        color: var(--highlight);
    }

    .search-button-label {
      background-color: var(--highlight);
      color: #fff;
      padding: 8px 15px;
      border: none;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .search-button-label:hover {
      background-color: #0056b3;
    }

    .search-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .search-filters select,
    .search-filters input[type="text"] {
      padding: 8px 12px;
      border: 1px solid var(--card-border);
      border-radius: 10px;
      background-color: var(--search-bg);
      color: var(--text);
      font-size: 0.9rem;
      min-width: 120px;
      flex: 1;
      max-width: 200px;
    }

    /* Search Suggestions Dropdown */
    .search-suggestions-container {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        right: 0;
        background-color: var(--suggestions-bg);
        border: 1px solid var(--suggestions-border);
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
    }

    .search-suggestions-container.show {
        display: block;
    }

    .search-suggestion-item {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        border-bottom: 1px solid var(--suggestions-border);
    }

    .search-suggestion-item:last-child {
        border-bottom: none;
    }

    .search-suggestion-item:hover {
        background-color: var(--suggestions-item-hover-bg);
    }

    .search-suggestion-item img {
        width: 40px;
        height: 60px;
        object-fit: cover;
        border-radius: 5px;
        margin-right: 10px;
        flex-shrink: 0;
    }

    .search-suggestion-info {
        flex-grow: 1;
        color: var(--text);
    }

    .search-suggestion-info h4 {
        font-size: 1rem;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .search-suggestion-info p {
        font-size: 0.85rem;
        color: var(--text);
        opacity: 0.7;
    }

    /* Main Content Area */
    main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        padding: 0;
        color: var(--text);
    }

    /* --- Initial Loading Screen --- */
    #loadingScreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: var(--bg);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s ease-out;
      opacity: 1;
      visibility: visible;
    }

    #loadingScreen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-text {
      font-size: 2rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 20px;
    }

    .loading-dots span {
      display: inline-block;
      width: 12px;
      height: 12px;
      margin: 0 5px;
      background-color: var(--highlight);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    .loading-dots span:nth-child(3) { animation-delay: 0s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* --- Cinema Guide Specific Styles --- */

    /* Hero Section */
    .hero-section-cinema {
        position: relative;
        width: 100%;
        height: 300px; /* Adjust height for cinema guide */
        background-size: cover;
        background-position: center;
        display: flex;
        flex-direction: column; /* To stack text horizontally */
        align-items: center;
        justify-content: center;
        color: white;
        overflow: hidden;
        transition: background-image 0.5s ease-in-out;
        padding-left: 0;
        padding-right: 0;
        text-align: center;
        background-color: #333; /* Fallback background */
    }

    .hero-overlay-cinema {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6); /* Consistent overlay */
        z-index: 1;
    }

    .hero-content-cinema {
        position: relative;
        z-index: 2;
        width: 100%;
        overflow: hidden;
        padding: 0 10px;
    }

    .hero-text-cinema {
        font-size: 2.8rem;
        font-weight: 700;
        white-space: nowrap;
        animation: scrollText 20s linear infinite;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.8);
        color: white;
        display: inline-block;
        padding-right: 100%;
    }

    @keyframes scrollText {
        0% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
    }

    .static-info-text {
        font-size: 1.2rem;
        font-weight: 500;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 15px;
        text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.7);
        padding: 0 20px;
    }


    /* Main Content Area */
    .cinema-guide-main {
        padding: 40px 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: var(--bg);
        transition: background-color 0.3s ease;
    }

    .page-title {
        font-size: 2.5rem;
        color: var(--text);
        margin-bottom: 30px;
        text-align: center;
    }

    /* City Filter */
    .city-filter {
        text-align: center;
        margin-bottom: 40px;
    }

    .city-filter label {
        font-size: 1.2rem;
        color: var(--text);
        margin-right: 15px;
        font-weight: 500;
    }

    .city-filter select {
        padding: 10px 15px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        background-color: var(--card-bg);
        color: var(--text);
        font-size: 1rem;
        cursor: pointer;
        outline: none;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23111%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.5H18.6c-5%200-9.3%201.8-13.2%206.5C1.8%2073.3%200%2077.5%200%2082.5c0%205%201.8%209.3%205.4%2013.2l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.7c3.6-3.5%205.4-7.8%205.4-12.8%200-5-1.8-9.3-5.4-13.2z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 10px top 50%;
        background-size: 12px;
    }
    body.dark-mode .city-filter select {
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23f0f0f0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.5H18.6c-5%200-9.3%201.8-13.2%206.5C1.8%2073.3%200%2077.5%200%2082.5c0%205%201.8%209.3%205.4%2013.2l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.7c3.6-3.5%205.4-7.8%205.4-12.8%200-5-1.8-9.3-5.4-13.2z%22%2F%3E%3C%2Fsvg%3E');
    }

    /* Cinema Halls Container */
    .city-cinema-halls-container {
        margin-top: 30px;
    }

    .cinema-hall-section {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 15px;
        box-shadow: 0 5px 15px var(--card-shadow);
        padding: 25px;
        margin-bottom: 40px;
    }

    .cinema-hall-title {
        font-size: 2rem;
        color: var(--highlight);
        margin-bottom: 25px;
        border-bottom: 2px solid var(--highlight);
        padding-bottom: 10px;
        display: inline-block;
    }

    .screening-shows-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
    }

    .show-card-cinema {
        background-color: var(--bg); /* Lighter background for individual show */
        border: 1px solid var(--card-border);
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        display: flex;
        flex-direction: column;
        position: relative; /* For network logo */
    }

    .show-card-cinema:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }

    .show-card-cinema-poster-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 140%; /* Poster aspect ratio */
        overflow: hidden;
    }

    .show-card-cinema-poster {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
    }
    /* Network Logo on TV show cards */
    .show-card-cinema .network-logo {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 5px;
        border-radius: 5px;
        z-index: 10;
        max-width: 60px; /* Limit logo size */
        height: auto;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    body.dark-mode .show-card-cinema .network-logo {
        background-color: rgba(0, 0, 0, 0.7);
    }

    .show-card-cinema-details {
        padding: 15px;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .show-card-cinema-title {
        font-size: 1.3rem;
        color: var(--text);
        margin-bottom: 8px;
        line-height: 1.2;
    }

    .show-card-cinema-meta {
        font-size: 0.9rem;
        color: var(--text);
        opacity: 0.7;
        margin-bottom: 10px;
    }

    .show-card-cinema-meta span i {
        color: gold;
        margin-right: 5px;
    }

    .show-card-cinema-episode-info {
        font-size: 0.85rem;
        color: var(--text);
        opacity: 0.8;
        margin-bottom: 10px;
    }

    .buy-ticket-btn {
        background-color: var(--primary-button);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: background-color 0.2s ease, transform 0.1s ease;
        margin-top: auto; /* Push button to bottom */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .buy-ticket-btn:hover {
        background-color: var(--primary-button-hover);
        transform: translateY(-2px);
    }

    /* --- Booking Modal (Stepper) --- */
    #bookingModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      visibility: hidden;
      opacity: 0;
      transition: visibility 0.3s ease, opacity 0.3s ease;
    }

    #bookingModal.show {
      visibility: visible;
      opacity: 1;
    }

    .booking-content {
      background-color: var(--bg);
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      width: 95%;
      max-width: 900px;
      height: 90%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .booking-header {
      padding: 15px 20px;
      background-color: var(--header-bg);
      border-bottom: 1px solid var(--card-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .booking-header h2 {
      font-size: 1.5rem;
      color: var(--text);
    }

    .close-modal-btn {
      background: none;
      border: none;
      font-size: 1.8rem;
      color: var(--text);
      cursor: pointer;
      transition: color 0.2s ease;
    }

    .close-modal-btn:hover {
      color: var(--danger);
    }

    .stepper-progress {
      display: flex;
      justify-content: space-around;
      padding: 15px 20px;
      background-color: var(--search-bg);
      border-bottom: 1px solid var(--card-border);
    }

    .step-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      text-align: center;
    }

    .step-circle {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--step-inactive);
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      margin-bottom: 5px;
      transition: background-color 0.3s ease;
      font-size: 0.9rem;
    }

    .step-item.active .step-circle {
      background-color: var(--step-active);
    }

    .step-item.completed .step-circle {
      background-color: var(--step-complete);
    }

    .step-name {
      font-size: 0.85rem;
      color: var(--text);
      opacity: 0.7;
    }

    .step-item.active .step-name {
      opacity: 1;
      font-weight: bold;
      color: var(--step-active);
    }
    .step-item.completed .step-name {
      color: var(--step-complete);
      font-weight: bold;
    }

    .step-content {
      flex-grow: 1;
      padding: 20px;
      overflow-y: auto;
      position: relative;
    }

    /* Specific Step Styles */
    #step0-show-details .show-details-summary {
        display: flex;
        gap: 30px;
        align-items: flex-start;
        margin-bottom: 30px;
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    #step0-show-details .show-details-summary img {
        width: 180px;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    #step0-show-details .show-info-summary {
        flex-grow: 1;
    }
    #step0-show-details .show-info-summary h3 {
        font-size: 2rem;
        color: var(--text);
        margin-bottom: 10px;
    }
    #step0-show-details .show-info-summary .meta-info {
        font-size: 0.95rem;
        color: var(--text);
        opacity: 0.8;
        margin-bottom: 15px;
    }
    #step0-show-details .show-info-summary .meta-info i {
        color: gold;
        margin-right: 5px;
    }
    #step0-show-details .show-info-summary p {
        font-size: 0.95rem;
        color: var(--text);
        line-height: 1.6;
        margin-bottom: 20px;
    }
    #step0-show-details .show-info-summary h4 {
        font-size: 1.1rem;
        color: var(--text);
        margin-bottom: 10px;
    }
    #step0-show-details .show-info-summary .cast-list-summary {
        font-size: 0.9rem;
        color: var(--text);
        opacity: 0.9;
        margin-bottom: 20px;
    }

    .proceed-to-purchase-btn {
        background-color: var(--primary-button);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 700;
        transition: background-color 0.2s ease, transform 0.1s ease;
        display: block;
        width: fit-content;
        margin: 0 auto;
    }
    .proceed-to-purchase-btn:hover {
        background-color: var(--primary-button-hover);
        transform: translateY(-2px);
    }

    /* Step 1: Seat Selection */
    #priceDisplay {
        text-align: right;
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--highlight);
        margin-bottom: 20px;
        background-color: var(--search-bg);
        padding: 10px;
        border-radius: 8px;
    }
    .seat-selection-container {
      border: 1px solid var(--card-border);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      background-color: var(--card-bg);
    }
    .screen-indicator {
      width: 80%;
      height: 10px;
      background-color: #333;
      margin: 0 auto 30px auto;
      border-radius: 5px;
      box-shadow: 0 3px 5px rgba(0,0,0,0.3);
    }
    .seats-grid {
      display: grid;
      grid-template-columns: repeat(15, 1fr); /* Example grid */
      gap: 8px;
      justify-content: center;
      width: fit-content;
      margin: 0 auto;
      padding: 20px;
      background-color: #f0f0f0; /* Light grey for seat area */
      border-radius: 10px;
    }
    body.dark-mode .seats-grid {
        background-color: #2a2a2a;
    }

    .seat {
      width: 30px;
      height: 30px;
      background-color: #c0c0c0; /* Available */
      border: 1px solid #999;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 0.7rem;
      font-weight: bold;
      transition: background-color 0.2s ease, transform 0.1s ease;
      color: #333;
    }
    .seat.occupied {
      background-color: #f44336; /* Red */
      cursor: not-allowed;
      opacity: 0.6;
      color: white;
    }
    .seat.selected {
      background-color: var(--highlight); /* Blue */
      color: white;
      transform: scale(1.05);
    }
    .seat:not(.occupied):hover {
      background-color: #a0a0a0;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
      font-size: 0.9rem;
      color: var(--text);
    }
    .legend-item {
      display: flex;
      align-items: center;
    }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 8px;
    }
    .legend-available { background-color: #c0c0c0; }
    .legend-occupied { background-color: #f44336; }
    .legend-selected { background-color: var(--highlight); }

    .stepper-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
    }
    .stepper-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .stepper-btn.primary {
        background-color: var(--primary-button);
        color: white;
    }
    .stepper-btn.primary:hover:not(:disabled) {
        background-color: var(--primary-button-hover);
        transform: translateY(-2px);
    }
    .stepper-btn.secondary {
        background-color: var(--secondary-button);
        color: white;
    }
    .stepper-btn.secondary:hover:not(:disabled) {
        background-color: #5a6268;
        transform: translateY(-2px);
    }
    .stepper-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Step 2: Snacks */
    .snacks-options {
        margin-bottom: 20px;
        text-align: center;
    }
    .snacks-options input[type="radio"] {
        margin-right: 8px;
        transform: scale(1.2);
    }
    .snacks-options label {
        font-size: 1.1rem;
        color: var(--text);
        margin-right: 20px;
    }

    .snacks-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }
    .snack-item {
        background-color: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 10px;
        padding: 15px;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .snack-item img {
        width: 100px;
        height: 100px;
        object-fit: contain;
        margin-bottom: 10px;
    }
    .snack-item label {
        font-size: 1.1rem;
        color: var(--text);
        font-weight: 500;
        margin-bottom: 5px;
    }
    .snack-item p {
        font-size: 0.9rem;
        color: var(--text);
        opacity: 0.8;
        margin-bottom: 10px;
    }
    .snack-item input[type="number"] {
        width: 70px;
        padding: 5px;
        border: 1px solid var(--card-border);
        border-radius: 5px;
        text-align: center;
        font-size: 1rem;
        color: var(--text);
        background-color: var(--bg);
    }
    .snack-item input[type="number"]:disabled {
        background-color: #eee;
        cursor: not-allowed;
        opacity: 0.7;
    }
    body.dark-mode .snack-item input[type="number"]:disabled {
        background-color: #444;
    }

    /* Step 3: Cab Service */
    .cab-service-options {
        margin-top: 20px;
    }
    .cab-service-options label {
        font-size: 1.1rem;
        color: var(--text);
        margin-bottom: 10px;
        display: block;
    }
    .cab-service-toggle {
        margin-bottom: 20px;
    }
    .cab-service-toggle input[type="radio"] {
        margin-right: 10px;
        transform: scale(1.2);
    }
    .cab-service-toggle label {
        display: inline-block;
        margin-right: 20px;
    }

    .address-input-group {
        margin-top: 20px;
        margin-bottom: 20px;
    }
    .address-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text);
    }
    .address-input-group input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        background-color: var(--bg);
        color: var(--text);
        font-size: 1rem;
    }
    .address-input-group input[type="text"]:disabled {
        background-color: #eee;
        cursor: not-allowed;
        opacity: 0.7;
    }
    body.dark-mode .address-input-group input[type="text"]:disabled {
        background-color: #444;
    }

    .cab-stand-selection select {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        background-color: var(--bg);
        color: var(--text);
        font-size: 1rem;
        appearance: none;
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23111%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.5H18.6c-5%200-9.3%201.8-13.2%206.5C1.8%2073.3%200%2077.5%200%2082.5c0%205%201.8%209.3%205.4%2013.2l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.7c3.6-3.5%205.4-7.8%205.4-12.8%200-5-1.8-9.3-5.4-13.2z%22%2F%3E%3C%2Fsvg%3E');
        background-repeat: no-repeat;
        background-position: right 10px top 50%;
        background-size: 12px;
    }
    body.dark-mode .cab-stand-selection select {
        background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23f0f0f0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.5H18.6c-5%200-9.3%201.8-13.2%206.5C1.8%2073.3%200%2077.5%200%2082.5c0%205%201.8%209.3%205.4%2013.2l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095.7c3.6-3.5%205.4-7.8%205.4-12.8%200-5-1.8-9.3-5.4-13.2z%22%2F%3E%3C%2Fsvg%3E');
    }

    /* Step 4: Summary */
    .summary-details {
        font-size: 1.1rem;
        color: var(--text);
        line-height: 1.8;
    }
    .summary-details strong {
        color: var(--highlight);
    }
    .total-price-summary {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--primary-button);
        text-align: right;
        margin-top: 30px;
        padding-top: 15px;
        border-top: 1px dashed var(--card-border);
    }

    /* Step 5: Payment */
    .payment-methods {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: center;
        margin-top: 30px;
    }
    .payment-method-item {
        border: 2px solid var(--card-border);
        border-radius: 10px;
        padding: 15px 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: var(--card-bg);
        width: 150px; /* Fixed width for payment options */
    }
    .payment-method-item.selected {
        border-color: var(--highlight);
        box-shadow: 0 0 15px rgba(0, 123, 255, 0.3); /* Using highlight variable */
        transform: translateY(-5px);
    }
    .payment-method-item img {
        width: 60px;
        height: 60px;
        object-fit: contain;
        margin-bottom: 10px;
    }
    .payment-method-item span {
        font-weight: 600;
        color: var(--text);
    }

    /* Payment icons (inline SVG examples for better styling) */
    .mpesa-icon { background-color: #32c450; padding: 10px; border-radius: 8px; } /* M-Pesa green */
    .card-icon { background-color: #007bff; padding: 10px; border-radius: 8px; } /* Blue for card */
    .paypal-icon { background-color: #003087; padding: 10px; border-radius: 8px; } /* PayPal blue */
    .crypto-icon { background-color: #f7931a; padding: 10px; border-radius: 8px; } /* Bitcoin orange */


    .confirm-payment-btn {
        background-color: var(--primary-button);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1.2rem;
        font-weight: 700;
        margin-top: 40px;
        display: block;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
        transition: background-color 0.2s ease, transform 0.1s ease;
    }
    .confirm-payment-btn:hover:not(:disabled) {
        background-color: var(--primary-button-hover);
        transform: translateY(-2px);
    }
    .confirm-payment-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Stepper navigation alignment */
    .stepper-navigation.center {
        justify-content: center;
        gap: 20px;
    }

    /* Footer */
    .main-footer {
      background-color: var(--header-bg);
      color: var(--text);
      padding: 30px 20px;
      text-align: center;
      border-top: 1px solid var(--card-border);
      font-size: 0.9rem;
    }

    .footer-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 20px;
    }

    .footer-section {
      flex: 1 1 200px;
      margin-bottom: 20px;
      text-align: left;
    }

    .footer-section h4 {
      font-size: 1.1rem;
      margin-bottom: 15px;
      color: var(--highlight);
    }

    .footer-section ul {
      list-style: none;
      padding: 0;
    }

    .footer-section ul li {
      margin-bottom: 8px;
    }

    .footer-section ul li a {
      color: var(--text);
      transition: color 0.2s ease;
    }

    .footer-section ul li a:hover {
      color: var(--highlight);
    }

    .footer-bottom {
      text-align: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid var(--card-border);
    }

    .footer-bottom p {
      margin-bottom: 10px;
    }

    .social-icons {
      margin-top: 15px;
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .social-icons a {
      color: var(--text);
      font-size: 1.5rem;
      transition: color 0.2s ease;
    }

    .social-icons a:hover {
      color: var(--highlight);
    }


    /* Responsive Design adjustments */
    @media (min-width: 1025px) {
        .shows-grid-container {
            grid-template-columns: repeat(4, 1fr);
            gap: 30px;
        }
    }

    @media (max-width: 1024px) {
        .shows-grid-container {
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }
        .show-card-grid-poster {
            height: 270px;
        }
    }

    @media (max-width: 768px) {
      /* Header Re-arrangement for small screens */
      .utility-header {
        flex-direction: column;
        text-align: center;
        padding-bottom: 10px;
      }
      .logo a {
        font-size: 1.5rem;
      }

      .header-utility-actions {
        width: 100%;
        justify-content: center;
        margin-top: 10px;
      }

      /* Hide desktop navigation on small screens */
      .main-nav-header {
        display: none;
      }

      /* Show mobile menu toggle icon on small screens */
      .mobile-menu-toggle {
        display: block;
      }
      /* Mobile nav links, hidden by default on mobile, toggled by JS */
      .mobile-nav-links {
          display: none;
          flex-direction: column;
          background-color: var(--header-bg);
          box-shadow: 0 2px 5px rgba(0,0,0,0.1);
          padding: 10px 20px;
          border-bottom: 1px solid var(--card-border);
      }
      /* Class added by JS to show the mobile menu */
      .mobile-nav-links.show-mobile-menu {
          display: flex;
      }
      .mobile-nav-links a {
        padding: 10px 0;
        text-align: center;
        border-bottom: 1px solid rgba(0,0,0,0.05);
        color: var(--text);
      }
      .mobile-nav-links a:last-child {
        border-bottom: none;
      }

      .footer-content {
        flex-direction: column;
        text-align: center;
      }

      .footer-section {
        flex: 1 1 100%;
        text-align: center;
      }

      .social-icons {
        justify-content: center;
      }

      .dynamic-search-area.show {
        max-height: 180px;
      }

      .search-input-wrapper {
        flex-wrap: wrap;
        justify-content: center;
      }

      .search-input-wrapper input[type="text"] {
        width: 100%;
        max-width: none;
      }

      /* Responsive Design for Modal */
        .booking-content {
            width: 98%;
            height: 95%;
        }
        .booking-header h2 {
            font-size: 1.2rem;
        }
        .close-modal-btn {
            font-size: 1.5rem;
        }
        .stepper-progress {
            padding: 10px 10px;
        }
        .step-circle {
            width: 25px;
            height: 25px;
            font-size: 0.8rem;
        }
        .step-name {
            font-size: 0.75rem;
        }
        .step-content {
            padding: 15px;
        }
        #step0-show-details .show-details-summary {
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        #step0-show-details .show-details-summary img {
            width: 150px;
        }
        #step0-show-details .show-info-summary h3 {
            font-size: 1.5rem;
        }
        #step0-show-details .show-info-summary .meta-info,
        #step0-show-details .show-info-summary p,
        #step0-show-details .show-info-summary .cast-list-summary {
            font-size: 0.85rem;
        }
        .proceed-to-purchase-btn {
            font-size: 1rem;
            padding: 10px 20px;
        }
        .seats-grid {
            grid-template-columns: repeat(10, 1fr); /* Adjust grid for smaller screens */
            gap: 6px;
            padding: 15px;
        }
        .seat {
            width: 25px;
            height: 25px;
            font-size: 0.6rem;
        }
        .legend {
            gap: 10px;
            font-size: 0.8rem;
        }
        .legend-color {
            width: 15px;
            height: 15px;
        }
        .snacks-container {
            grid-template-columns: repeat(2, 1fr); /* 2 columns on mobile */
            gap: 15px;
        }
        .snack-item {
            padding: 10px;
        }
        .snack-item img {
            width: 80px;
            height: 80px;
        }
        .snack-item label {
            font-size: 1rem;
        }
        .snack-item p {
            font-size: 0.8rem;
        }
        .snack-item input[type="number"] {
            width: 60px;
        }
        .no-thanks-option {
            font-size: 1rem;
        }
        .payment-methods {
            flex-direction: column;
            align-items: center;
        }
        .payment-method-item {
            width: 100%;
            max-width: 200px;
        }
    }

    @media (max-width: 480px) {
        .hero-text-cinema {
            font-size: 2rem;
        }
        .page-title {
            font-size: 2rem;
        }
        .city-filter label {
            font-size: 1rem;
            margin-right: 10px;
        }
        .city-filter select {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        .cinema-hall-title {
            font-size: 1.5rem;
        }
        .screening-shows-grid {
            grid-template-columns: 1fr; /* Single column */
        }
        .show-card-cinema-details {
            padding: 10px;
        }
        .show-card-cinema-title {
            font-size: 1.1rem;
        }
        .show-card-cinema-meta,
        .show-card-cinema-episode-info {
            font-size: 0.8rem;
        }
        .buy-ticket-btn {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        .booking-content {
            height: 98%;
        }
        #priceDisplay {
            font-size: 1.2rem;
        }
        .seats-grid {
            grid-template-columns: repeat(8, 1fr); /* Even smaller seat grid */
            gap: 4px;
        }
        .snack-item img {
            width: 60px;
            height: 60px;
        }
        .snack-item label {
            font-size: 0.9rem;
        }
        .snack-item p {
            font-size: 0.75rem;
        }
        .snack-item input[type="number"] {
            width: 50px;
            font-size: 0.9rem;
        }
        .stepper-btn {
            font-size: 0.9rem;
            padding: 8px 15px;
        }
        .confirm-payment-btn {
            font-size: 1rem;
            padding: 10px 20px;
        }
    }

    /* Explicitly hide desktop navigation and mobile elements on large screens */
    @media (min-width: 769px) {
        .mobile-nav-links,
        .mobile-menu-toggle {
            display: none !important;
        }
        .main-nav-header {
            display: flex !important;
        }
    }
  </style>
</head>
<body>
  <!-- Custom Alert/Message Box Structure -->
  <div id="customAlert" class="custom-alert-overlay">
    <div class="alert-content">
        <i class="fas fa-info-circle alert-icon blue-icon"></i>
        <p id="alertMessage">This is a custom message.</p>
        <button id="closeAlertBtn" class="close-alert-btn">OK</button>
    </div>
  </div>

  <!-- Initial Loading Screen -->
  <div id="loadingScreen">
    <div class="loading-text">Preparing Your Watch Experience</div>
    <div class="loading-dots">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <header class="main-global-header">
    <!-- Utility Header: Logo, Search Toggle, Account, Dark Mode, Mobile Menu Toggle -->
    <div class="utility-header">
      <div class="logo">
        <a href="index.html">CineWatch</a>
      </div>
      <div class="header-utility-actions">
        <!-- Search Icon (toggles expanded search bar) -->
        <div class="search-bar-toggle">
          <button class="search-toggle-button" id="searchToggleButton" aria-label="Toggle Search">
            <i class="fas fa-search"></i>
          </button>
        </div>

        <!-- Account Menu -->
        <div class="account-menu">
          <button class="account-button" id="accountButton" aria-label="Account Menu">
            <i class="fas fa-user-circle"></i>
          </button>
          <div class="account-dropdown" id="accountDropdown">
            <a href="profile.html" id="desktopProfileLink" class="account-item"><i class="fas fa-user"></i> Profile</a>
            <a href="settings.html" id="desktopSettingsLink" class="account-item"><i class="fas fa-cog"></i> Settings</a>
            <a href="watchlist.html" id="desktopWatchlistLink" class="account-item"><i class="fas fa-bookmark"></i> Watchlist</a>
            <a href="history.html" id="desktopHistoryLink" class="account-item"><i class="fas fa-history"></i> History</a>
            <a href="login.html" id="desktopLoginLink" class="account-item"><i class="fas fa-sign-in-alt"></i> Login</a>
            <a href="register.html" id="desktopRegisterLink" class="account-item"><i class="fas fa-user-plus"></i> Register</a>
            <a href="#" id="desktopLogoutLink" class="account-item"><i class="fas fa-sign-out-alt"></i> Logout</a>
          </div>
        </div>

        <!-- Dark Mode Toggle -->
        <button class="theme-toggle-button" id="darkModeToggle" aria-label="Toggle Dark Mode" title="Toggle Dark Mode">
          <i class="fas fa-moon"></i>
        </button>

        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle Mobile Menu">
          <i class="fas fa-bars"></i>
        </button>
      </div>
    </div>

    <!-- Main Navigation Header (Desktop Only) -->
    <nav class="main-nav-header" id="mainNavHeader">
      <a href="movies.html?type=movie">Movies</a>
      <a href="tvshows.html">TV Shows</a>
      <a href="watchlist.html">Watchlist</a>
      <a href="tv_networks.html">TV Networks</a>
      <a href="cinema_guide.html">Cinemaguide</a>
      <a href="about_us.html">About Us</a>
    </nav>
  </header>

  <!-- Mobile Navigation Menu (Hidden by default, shown by JS toggle) -->
  <nav class="mobile-nav-links" id="mobileNavLinks">
    <a href="movies.html?type=movie">Movies</a>
    <a href="tvshows.html">TV Shows</a>
    <a href="watchlist.html">Watchlist</a>
    <a href="tv_networks.html">TV Networks</a>
    <a href="cinema_guide.html">Cinemaguide</a>
    <a href="about_us.html">About Us</a>
    <!-- Account links for mobile -->
    <a href="profile.html" id="mobileProfileLink">Profile</a>
    <a href="settings.html" id="mobileSettingsLink">Settings</a>
    <a href="watchlist.html" id="mobileWatchlistLink">Watchlist</a>
    <a href="history.html" id="mobileHistoryLink">History</a>
    <a href="login.html" id="mobileLoginLink">Login</a>
    <a href="#" id="mobileRegisterLink">Register</a>
    <a href="#" id="mobileLogoutLink">Logout</a>
  </nav>

  <!-- Dynamic Search Input Area (Animated reveal) -->
  <section class="dynamic-search-area" id="dynamicSearchArea">
    <div class="search-input-wrapper">
      <input type="text" id="expandedSearchBar" placeholder="Search movies, shows, cast..." aria-label="Expanded Search Bar">
      <button class="search-icon-btn" id="micIconBtn" aria-label="Voice Search"><i class="fas fa-microphone"></i></button>
      <button class="search-icon-btn clear-search-btn" id="clearSearchBtn" aria-label="Clear Search"><i class="fas fa-times"></i></button>
      <button class="search-button-label" id="searchActionBtn">Search</button>
    </div>
    <!-- Search Suggestions Container -->
    <div class="search-suggestions-container" id="searchSuggestionsContainer">
      <!-- Suggestions will be populated here -->
    </div>
    <div class="search-filters">
      <select id="genreFilter" aria-label="Filter by Genre">
        <option value="">All Genres</option>
        <!-- Genres will be dynamically populated here by JS -->
      </select>
      <select id="yearFilter" aria-label="Filter by Release Year">
        <option value="">All Years</option>
        <!-- Years will be dynamically populated here by JS -->
      </select>
      <input type="text" id="castFilter" placeholder="Filter by Cast" aria-label="Filter by Cast">
    </div>
  </section>

  <main class="cinema-guide-main">
    <!-- Hero Section for Cinema Guide -->
    <section id="cinemaHero" class="hero-section-cinema">
        <div class="hero-overlay-cinema"></div>
        <div class="hero-content-cinema">
            <h1 class="hero-text-cinema">Now Showing In Cinemas</h1>
            <!-- Removed animatedShowInfo as the hero is now purely aesthetic with rotating backdrops -->
        </div>
    </section>

    <h1 class="page-title">Find Shows Near You</h1>

    <!-- City Filter -->
    <div class="city-filter">
        <label for="citySelect">Select City:</label>
        <select id="citySelect">
            <option value="all">All Cities</option>
            <option value="Nairobi">Nairobi</option>
            <option value="Kisumu">Kisumu</option>
            <option value="Mombasa">Mombasa</option>
            <option value="Eldoret">Eldoret</option>
            <option value="Nakuru">Nakuru</option>
        </select>
    </div>

    <!-- Cinema Halls Container -->
    <div id="cinemaHallsContainer" class="city-cinema-halls-container">
        <!-- Cinema halls and their shows will be dynamically loaded here -->
    </div>
  </main>

  <footer class="main-footer">
    <div class="footer-content">
      <div class="footer-section">
        <h4>About CineWatch</h4>
        <ul>
          <li><a href="about_us.html">Our Story</a></li>
          <li><a href="contact.html">Contact Us</a></li>
          <li><a href="careers.html">Careers</a></li>
          <li><a href="investors.html">Investors</a></li>
          <li><a href="about_developer.html">About Developer</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Help & Support</h4>
        <ul>
          <li><a href="support.html">FAQ</a></li>
          <li><a href="terms_of_service.html">Terms of Service</a></li>
          <li><a href="privacy_policy.html">Privacy Policy</a></li>
          <li><a href="sitemap.xml">Sitemap</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Explore</h4>
        <ul>
          <li><a href="movies.html?type=movie">Movies</a></li>
          <li><a href="tvshows.html">TV Shows</a></li>
          <li><a href="watchlist.html">Watchlist</a></li>
          <li><a href="new_releases.html">New Releases</a></li>
        </ul>
      </div>
      <div class="footer-section">
        <h4>Connect with Us</h4>
        <p>Stay updated on our latest releases and news.</p>
        <div class="social-icons">
          <a href="https://www.facebook.com/aslekiymastamynd" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
          <a href="https://x.com/yourhandle" target="_blank" rel="noopener noreferrer" aria-label="X (formerly Twitter)"><i class="fab fa-twitter"></i></a>
          <a href="https://www.instagram.com/yourprofile" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
          <a href="https://www.linkedin.com/in/alexmalunda" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      <p>&copy; <span id="current-year"></span> CineWatch. All rights reserved.</p>
      <p>Last Modified: <span id="last-modified"></span></p>
    </div>
  </footer>

  <!-- Booking Modal (Multi-step form) -->
  <div id="bookingModal" class="custom-alert-overlay">
    <div class="booking-content">
      <div class="booking-header">
        <h2 id="modalTitle">Book Your Tickets</h2>
        <button class="close-modal-btn" id="closeBookingModal">&times;</button>
      </div>
      <div class="stepper-progress">
        <div class="step-item active" data-step="0">
          <span class="step-circle">1</span>
          <span class="step-name">Details</span>
        </div>
        <div class="step-item" data-step="1">
          <span class="step-circle">2</span>
          <span class="step-name">Seats</span>
        </div>
        <div class="step-item" data-step="2">
          <span class="step-circle">3</span>
          <span class="step-name">Snacks</span>
        </div>
        <div class="step-item" data-step="3">
          <span class="step-circle">4</span>
          <span class="step-name">Cab</span>
        </div>
        <div class="step-item" data-step="4">
          <span class="step-circle">5</span>
          <span class="step-name">Summary</span>
        </div>
        <div class="step-item" data-step="5">
          <span class="step-circle">6</span>
          <span class="step-name">Payment</span>
        </div>
      </div>

      <div class="step-content">
        <!-- Step 0: Show Details Confirmation -->
        <div id="step0-show-details" class="booking-step active">
            <h3 style="text-align: center; color: var(--text); margin-bottom: 20px;">Confirm Your Selection</h3>
            <div class="show-details-summary">
                <img id="summaryShowPoster" src="" alt="Show Poster" onerror="this.onerror=null;this.src='https://placehold.co/180x252/333/fff?text=No+Poster';">
                <div class="show-info-summary">
                    <h3 id="summaryShowTitle"></h3>
                    <p class="meta-info">
                        <span id="summaryShowGenre"></span> |
                        <span id="summaryShowYear"></span> |
                        <span id="summaryShowRating"></span>
                    </p>
                    <p id="summaryShowDescription"></p>
                    <h4>Main Cast:</h4>
                    <p class="cast-list-summary" id="summaryShowCast"></p>
                </div>
            </div>
            <button class="proceed-to-purchase-btn" id="proceedToPurchase">Proceed to Purchase Ticket</button>
        </div>

        <!-- Step 1: Seat Selection -->
        <div id="step1-seat-selection" class="booking-step" style="display:none;">
            <div id="priceDisplay">Total Price: KES 0.00</div>
            <div class="seat-selection-container">
                <div class="screen-indicator"></div>
                <div id="seatsGrid" class="seats-grid">
                    <!-- Seats will be generated here -->
                </div>
                <div class="legend">
                    <div class="legend-item"><span class="legend-color legend-available"></span> Available</div>
                    <div class="legend-item"><span class="legend-color legend-occupied"></span> Occupied</div>
                    <div class="legend-item"><span class="legend-color legend-selected"></span> Selected</div>
                </div>
            </div>
            <div class="stepper-navigation center">
                <button class="stepper-btn primary" id="nextStep1" disabled>Proceed to Next</button>
            </div>
        </div>

        <!-- Step 2: Snacks -->
        <div id="step2-snacks" class="booking-step" style="display:none;">
            <h3 style="text-align: center; color: var(--text); margin-bottom: 20px;">Choose Your Snacks (Optional)</h3>
            <div class="snacks-options">
                <input type="radio" id="yesSnacks" name="snackSelectionOption" value="yes">
                <label for="yesSnacks">Yes, I want snacks</label>
                <input type="radio" id="noSnacks" name="snackSelectionOption" value="no" checked>
                <label for="noSnacks">No thanks, I don't want snacks</label>
            </div>
            <div class="snacks-container" id="snacksContainer">
                <!-- Snacks will be generated here -->
            </div>
            <div class="stepper-navigation">
                <button class="stepper-btn secondary" id="prevStep2">Back</button>
                <button class="stepper-btn primary" id="nextStep2">Proceed to Next</button>
            </div>
        </div>

        <!-- Step 3: Cab Service -->
        <div id="step3-cab-service" class="booking-step" style="display:none;">
            <h3 style="text-align: center; color: var(--text); margin-bottom: 20px;">Book a Cab (Optional)</h3>
            <div class="cab-service-options">
                <div class="cab-service-toggle">
                    <input type="radio" id="noCabService" name="cabOption" value="none" checked>
                    <label for="noCabService">No, I don't need a cab service</label>
                    <input type="radio" id="yesCabService" name="cabOption" value="yes">
                    <label for="yesCabService">Yes, I need a cab service</label>
                </div>

                <div id="cabDetails" style="display: none;">
                    <div class="address-input-group">
                        <input type="radio" id="pickupHome" name="pickupType" value="home" checked>
                        <label for="pickupHome">Pick up from my Home Address</label>
                        <input type="text" id="homeAddressInput" placeholder="Enter your home address" required>
                    </div>

                    <div class="address-input-group">
                        <input type="radio" id="pickupCabStand" name="pickupType" value="cab_stand">
                        <label for="pickupCabStand">Pick up from a Cab Stand</label>
                        <select id="cabStandSelect" disabled>
                            <option value="">Select a cab stand</option>
                            <!-- Cab stands dynamically loaded -->
                        </select>
                    </div>
                </div>
            </div>
            <div class="stepper-navigation">
                <button class="stepper-btn secondary" id="prevStep3">Back</button>
                <button class="stepper-btn primary" id="nextStep3">Proceed to Next</button>
            </div>
        </div>

        <!-- Step 4: Summary -->
        <div id="step4-summary" class="booking-step" style="display:none;">
            <h3 style="text-align: center; color: var(--text); margin-bottom: 20px;">Order Summary</h3>
            <div class="summary-details">
                <p><strong>Show:</strong> <span id="summaryShowName"></span></p>
                <p><strong>Cinema Hall:</strong> <span id="summaryCinemaHall"></span></p>
                <p><strong>City:</strong> <span id="summaryCity"></span></p>
                <p><strong>Seat:</strong> <span id="summarySeat"></span></p>
                <p><strong>Snacks:</strong> <span id="summarySnacks"></span></p>
                <p><strong>Cab Service:</strong> <span id="summaryCabService"></span></p>
                <p class="total-price-summary">Total Payable: KES <span id="summaryTotalPrice">0.00</span></p>
            </div>
            <div class="stepper-navigation">
                <button class="stepper-btn secondary" id="prevStep4">Back</button>
                <button class="stepper-btn primary" id="nextStep4">Proceed to Payment</button>
            </div>
        </div>

        <!-- Step 5: Payment -->
        <div id="step5-payment" class="booking-step" style="display:none;">
            <h3 style="text-align: center; color: var(--text); margin-bottom: 20px;">Select Payment Method</h3>
            <div class="payment-methods">
                <div class="payment-method-item" data-method="mpesa">
                    <img src="images/icons_logos/mpesa.svg" alt="M-Pesa" onerror="this.onerror=null;this.src='https://placehold.co/60x60/32c450/FFFFFF?text=M-Pesa';">
                    <span>M-Pesa</span>
                </div>
                <div class="payment-method-item" data-method="card">
                    <img src="images/icons_logos/card.svg" alt="Card" onerror="this.onerror=null;this.src='https://placehold.co/60x60/007bff/FFFFFF?text=Card';">
                    <span>Card</span>
                </div>
                <div class="payment-method-item" data-method="paypal">
                    <img src="images/icons_logos/paypal.svg" alt="PayPal" onerror="this.onerror=null;this.src='https://placehold.co/60x60/003087/FFFFFF?text=PayPal';">
                    <span>PayPal</span>
                </div>
                <div class="payment-method-item" data-method="crypto">
                    <img src="images/icons_logos/crypto.svg" alt="Crypto" onerror="this.onerror=null;this.src='https://placehold.co/60x60/f7931a/FFFFFF?text=Crypto';">
                    <span>Crypto</span>
                </div>
            </div>
            <div class="stepper-navigation center">
                <button class="stepper-btn secondary" id="prevStep5">Back</button>
                <button class="confirm-payment-btn" id="confirmPaymentBtn" disabled>Confirm Payment</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Consolidated JavaScript -->
  <script>
    // Global state for user login (simulated)
    let userLoggedIn = false;

    // TMDB API Configuration (using a placeholder for now, actual key from user context)
    const TMDB_API_KEY = '9c198aabc1df9fa96ea8d65e183cb8a3'; // Placeholder, replace with actual if provided
    const TMDB_BASE_URL = 'https://api.themoviedb.org/3';
    const TMDB_IMAGE_BASE_URL = 'https://image.tmdb.org/t/p/';
    const POSTER_SIZE = 'w342';
    const BACKDROP_SIZE = 'w1280'; // For hero section backdrops
    const LOGO_SIZE = 'w92'; // For network logos

    // Transparent GIF for image fallback (avoids external placeholder services)
    const IMAGE_NOT_FOUND_URL = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';


    // Data for Cinema Halls and their shows (using TMDB IDs now)
    // These IDs are pre-selected to represent various popular movies and TV shows from TMDB.
    const cinemaData = {
        Nairobi: [
            {
                name: "Anga IMAX (CBD)",
                welcomeMessage: "Welcome to Anga IMAX, Nairobi! Prepare for an immersive cinematic journey!",
                shows: [
                    { id: 980489, media_type: 'movie', time: '10:00 AM', price: 950, is3D: true, seats: generateRandomSeats(15, 10, 0.2) }, // The Flash
                    { id: 100088, media_type: 'tv', time: '01:00 PM', price: 800, isSeries: true, season: 1, episode: 1, seats: generateRandomSeats(15, 10, 0.3) }, // House of the Dragon (Episode 1)
                    { id: 872585, media_type: 'movie', time: '04:00 PM', price: 850, seats: generateRandomSeats(15, 10, 0.1) }, // Oppenheimer
                    { id: 346698, media_type: 'movie', time: '07:00 PM', price: 900, seats: generateRandomSeats(15, 10, 0.4) }, // Barbie
                    // New additions
                    { id: 61889, media_type: 'tv', time: '09:00 AM', price: 700, isSeries: true, season: 1, episode: 1, seats: generateRandomSeats(15, 10, 0.2) }, // The Daily Show
                    { id: 155, media_type: 'movie', time: '09:30 PM', price: 950, seats: generateRandomSeats(15, 10, 0.3) } // The Dark Knight
                ]
            },
            {
                name: "Prestige Plaza (Ngong Road)",
                welcomeMessage: "Enjoy your movie at Prestige Plaza! Comfort and convenience await.",
                shows: [
                    { id: 76479, media_type: 'tv', time: '11:30 AM', price: 700, isSeries: true, season: 3, episode: 1, seats: generateRandomSeats(12, 8, 0.15) }, // The Boys (Episode 1)
                    { id: 693134, media_type: 'movie', time: '02:30 PM', price: 650, seats: generateRandomSeats(12, 8, 0.2) }, // Dune: Part Two
                    { id: 100201, media_type: 'tv', time: '05:30 PM', price: 750, isSeries: true, season: 1, episode: 3, seats: generateRandomSeats(12, 8, 0.1) }, // Severance (Episode 3)
                    { id: 940551, media_type: 'movie', time: '08:00 PM', price: 600, seats: generateRandomSeats(12, 8, 0.05) }, // Migration
                    // New additions
                    { id: 25487, media_type: 'movie', time: '01:30 PM', price: 680, seats: generateRandomSeats(12, 8, 0.25) }, // Madea Goes to Jail
                    { id: 110486, media_type: 'tv', time: '10:00 PM', price: 550, isSeries: true, season: 1, episode: 1, seats: generateRandomSeats(12, 8, 0.18) } // Too Hot to Handle: Spain
                ]
            },
            {
                name: "Two Rivers (Limuru Road)",
                welcomeMessage: "Welcome to Two Rivers Cinema! The ultimate family entertainment destination.",
                shows: [
                    { id: 135805, media_type: 'tv', time: '10:00 AM', price: 700, isSeries: true, season: 2, episode: 1, seats: generateRandomSeats(10, 7, 0.1) }, // Reacher (Episode 1)
                    { id: 1011985, media_type: 'movie', time: '01:00 PM', price: 750, seats: generateRandomSeats(10, 7, 0.08) }, // Kung Fu Panda 4
                    { id: 823464, media_type: 'movie', time: '04:00 PM', price: 600, seats: generateRandomSeats(10, 7, 0.25) } // Godzilla x Kong: The New Empire
                ]
            }
        ],
        Kisumu: [
            {
                name: "Mega City Cinemas",
                welcomeMessage: "Jambo Kisumu! Enjoy your film at Mega City Cinemas.",
                shows: [
                    { id: 112028, media_type: 'tv', time: '11:00 AM', price: 500, isSeries: true, season: 1, episode: 2, seats: generateRandomSeats(10, 7, 0.3) }, // Shgun (Episode 2)
                    { id: 635919, media_type: 'movie', time: '02:00 PM', price: 450, seats: generateRandomSeats(10, 7, 0.15) }, // Inside Out 2
                    // New additions
                    { id: 521877, media_type: 'movie', time: '03:00 PM', price: 480, seats: generateRandomSeats(10, 7, 0.1) }, // Parchs: the Documentary
                    { id: 10769, media_type: 'movie', time: '07:30 PM', price: 520, seats: generateRandomSeats(10, 7, 0.2) } // Police Story (Jackie Chan)
                ]
            },
            {
                name: "Lake Basin Mall Cinema",
                welcomeMessage: "Karibu Lake Basin Mall Cinema! Your comfort is our priority.",
                shows: [
                    { id: 533535, media_type: 'movie', time: '04:00 PM', price: 550, seats: generateRandomSeats(8, 6, 0.1) } // Deadpool & Wolverine
                ]
            }
        ],
        Mombasa: [
            {
                name: "Nyali Cinemax",
                welcomeMessage: "Welcome to Nyali Cinemax, Mombasa! Dive into the magic of movies by the coast.",
                shows: [
                    { id: 786893, media_type: 'movie', time: '10:30 AM', price: 600, seats: generateRandomSeats(14, 9, 0.2) }, // Furiosa: A Mad Max Saga
                    { id: 120587, media_type: 'tv', time: '01:30 PM', price: 550, isSeries: true, season: 1, episode: 1, seats: generateRandomSeats(14, 9, 0.25) }, // Fallout (Episode 1)
                    // New additions
                    { id: 465910, media_type: 'movie', time: '08:30 PM', price: 700, seats: generateRandomSeats(14, 9, 0.15) }, // Tiger Zinda Hai (Salman Khan)
                    { id: 61972, media_type: 'tv', time: '10:30 PM', price: 600, isSeries: true, season: 1, episode: 1, seats: generateRandomSeats(14, 9, 0.1) } // The Tonight Show Starring Jimmy Fallon
                ]
            },
            {
                name: "City Mall Cinema",
                welcomeMessage: "City Mall Cinema welcomes you! Your ultimate entertainment hub in Mombasa.",
                shows: [
                    { id: 603692, media_type: 'movie', time: '04:30 PM', price: 650, seats: generateRandomSeats(12, 8, 0.1) }, // Despicable Me 4
                    { id: 73586, media_type: 'tv', time: '07:30 PM', price: 600, isSeries: true, season: 5, episode: 8, seats: generateRandomSeats(12, 8, 0.05) } // Yellowstone (Episode 8)
                ]
            }
        ],
        Eldoret: [
            {
                name: "Rupa's Mall Cinema",
                welcomeMessage: "Greetings from Rupa's Mall Cinema, Eldoret! Great movies await.",
                shows: [
                    { id: 980489, media_type: 'movie', time: '12:00 PM', price: 500, seats: generateRandomSeats(10, 7, 0.3) }, // The Flash (repeated show for variety)
                    { id: 100088, media_type: 'tv', time: '03:00 PM', price: 450, isSeries: true, season: 1, episode: 2, seats: generateRandomSeats(10, 7, 0.1) }, // House of the Dragon (Episode 2)
                    // New addition
                    { id: 480530, media_type: 'movie', time: '10:00 AM', price: 520, seats: generateRandomSeats(10, 7, 0.22) } // A Madea Family Funeral
                ]
            }
        ],
        Nakuru: [
            {
                name: "Westside Mall Cinema",
                welcomeMessage: "Hello Nakuru! Experience cinematic magic at Westside Mall.",
                shows: [
                    { id: 872585, media_type: 'movie', time: '01:00 PM', price: 500, seats: generateRandomSeats(10, 7, 0.2) }, // Oppenheimer (repeated)
                    { id: 346698, media_type: 'movie', time: '04:00 PM', price: 550, seats: generateRandomSeats(10, 7, 0.15) }, // Barbie (repeated)
                    // New additions
                    { id: 15159, media_type: 'movie', time: '07:00 PM', price: 580, seats: generateRandomSeats(10, 7, 0.1) }, // Ip Man (Donnie Yen)
                    { id: 808943, media_type: 'movie', time: '02:30 PM', price: 530, seats: generateRandomSeats(10, 7, 0.2) } // Pushpa: The Rise - Part 1 (Allu Arjun)
                ]
            }
        ]
    };

    // Cab Service Data - Remains the same
    const cabServiceData = {
        Uber: { logo: 'images/icons_logos/uberlogo.svg', locations: {
            Nairobi: ['Westlands Uber Cab Stand', 'Parklands Uber Cab Stand', 'Upperhill Uber Cab Stand', 'Lang\'ata Uber Cab Stand'],
            Kisumu: ['Nyalenda East Uber Cab Stand', 'Airport Uber Cab Stand'],
            Mombasa: ['Serena Uber Cab Stand', 'Bamburi Uber Cab Stand'],
            Eldoret: ['Langas Uber Cab Stand', 'Roadblock Uber Cab Stand'],
            Nakuru: ['Bahati Uber Cab Stand', 'Campus Drive Uber Cab Stand']
        }},
        Bolt: { logo: 'images/icons_logos/boltlogo.svg', locations: {
            Nairobi: ['CBD Bolt Cab Stand', 'Kilimani Bolt Cab Stand', 'Karen Bolt Cab Stand'],
            Kisumu: ['Milimani Bolt Cab Stand', 'Kisumu CBD Bolt Stand'],
            Mombasa: ['Bombolulu Bolt Cab Stand', 'Mtwapa Bolt Cab Stand'],
            Eldoret: ['Laxo Bolt Cab Stand', 'Kapsoya Bolt Cab Stand'],
            Nakuru: ['Njoro Bolt Cab Stand', 'Town Centre Bolt Cab Stand']
        }},
        "Little Cab": { logo: 'images/icons_logos/littlecablogo.svg', locations: {
            Nairobi: ['Gigiri Little Cab Stand', 'Lavington Little Cab Stand'],
            Kisumu: ['Bus Station Little Cab Stand'],
            Mombasa: ['Mpeketoni Little Cab Stand'],
            Eldoret: ['Plateau Little Cab Stand'],
            Nakuru: ['Milimani Little Cab Stand']
        }},
        Faras: { logo: 'images/icons_logos/faraslogo.svg', locations: {
            Nairobi: ['Thika Road Faras Cab Stand', 'Ngong Road Faras Cab Stand'],
            Kisumu: ['Ondiek Faras Cab Stand'],
            Mombasa: ['Likoni Faras Cab Stand'],
            Eldoret: ['Huruma Faras Cab Stand'],
            Nakuru: ['Kapsabet Faras Cab Stand']
        }},
        Oya: { logo: 'images/icons_logos/oyalogo.svg', locations: {
            Nairobi: ['Rongai Oya Cab Stand'],
            Kisumu: ['Bondo Oya Cab Stand'],
            Mombasa: ['Diani Oya Cab Stand'],
            Eldoret: ['Town Centre Oya Cab Stand'],
            Nakuru: ['Kiamunyi Oya Cab Stand']
        }}
    };

    const snacksData = [
        { name: "Popcorn (Large)", price: 300, image: "images/snacks/popcorns.webp" },
        { name: "Coca-Cola", price: 150, image: "images/snacks/cocacola.webp" },
        { name: "Nachos with Cheese", price: 400, image: "images/snacks/nachos.webp" },
        { name: "Bottled Water", price: 100, image: "images/snacks/bottledwater.webp" }
    ];


    // --- Global State for Booking ---
    let currentBooking = {
        showDetails: null, // Will store full TMDB show object
        cinemaHall: null,
        city: null,
        selectedSeat: null,
        snacks: [],
        cabService: {
            needed: false,
            pickupType: 'home', // 'home' or 'cab_stand'
            address: '',
            cabStand: ''
        },
        totalPrice: 0,
        selectedPaymentMethod: null
    };

    // Array to store recently fetched backdrops for hero rotation
    const heroBackdrops = [];
    const MAX_HERO_BACKDROPS = 5;


    /**
     * Helper to fetch movie details by ID.
     * @param {number} movieId - TMDB movie ID.
     * @returns {Promise<Object|null>} Movie details.
     */
    async function fetchMovieDetails(movieId) {
        try {
            const response = await fetch(`${TMDB_BASE_URL}/movie/${movieId}?api_key=${TMDB_API_KEY}&language=en-US`);
            if (!response.ok) {
                console.error(`Error fetching movie ${movieId}: ${response.statusText}`);
                return null;
            }
            return response.json();
        } catch (error) {
            console.error(`Failed to fetch movie ${movieId}:`, error);
            return null;
        }
    }

    /**
     * Helper to fetch TV show details by ID.
     * @param {number} tvShowId - TMDB TV show ID.
     * @returns {Promise<Object|null>} TV show details.
     */
    async function fetchTvShowDetails(tvShowId) {
        try {
            const response = await fetch(`${TMDB_BASE_URL}/tv/${tvShowId}?api_key=${TMDB_API_KEY}&language=en-US`);
            if (!response.ok) {
                console.error(`Error fetching TV show ${tvShowId}: ${response.statusText}`);
                return null;
            }
            return response.json();
        } catch (error) {
            console.error(`Failed to fetch TV show ${tvShowId}:`, error);
            return null;
        }
    }


    /**
     * Generates a random seating arrangement for a cinema hall.
     * @param {number} rows - Number of rows.
     * @param {number} cols - Number of columns.
     * @param {number} occupiedRatio - Ratio of occupied seats (e.g., 0.2 for 20% occupied).
     * @returns {Array<Object>} An array of seat objects.
     */
    function generateRandomSeats(rows, cols, occupiedRatio) {
        const seats = [];
        for (let r = 0; r < rows; r++) {
            for (let c = 0; c < cols; c++) {
                const isOccupied = Math.random() < occupiedRatio;
                const seatId = `${String.fromCharCode(65 + r)}${c + 1}`; // e.g., A1, A2...
                seats.push({ id: seatId, occupied: isOccupied, selected: false });
            }
        }
        return seats;
    }

    /**
     * Renders cinema halls and their shows based on the selected city.
     * @param {string} city - The city to filter by (e.g., 'Nairobi', 'all').
     */
    async function renderCinemaHalls(city) {
        const container = document.getElementById('cinemaHallsContainer');
        container.innerHTML = '<p style="text-align: center; margin-top: 20px;">Loading shows...</p>'; // Loading indicator

        const citiesToDisplay = city === 'all' ? Object.keys(cinemaData) : [city];
        let contentGenerated = false;

        for (const cityName of citiesToDisplay) {
            const hallsInCity = cinemaData[cityName];
            if (!hallsInCity || hallsInCity.length === 0) {
                continue;
            }

            for (const hall of hallsInCity) {
                const hallSection = document.createElement('section');
                hallSection.classList.add('cinema-hall-section');
                hallSection.innerHTML = `
                    <h2 class="cinema-hall-title">${hall.name}</h2>
                    <div class="screening-shows-grid">
                        <!-- Shows for this hall will go here -->
                    </div>
                `;
                const showsGrid = hallSection.querySelector('.screening-shows-grid');

                for (const showtime of hall.shows) {
                    let showDetails = null;
                    if (showtime.media_type === 'movie') {
                        showDetails = await fetchMovieDetails(showtime.id);
                    } else if (showtime.media_type === 'tv') {
                        showDetails = await fetchTvShowDetails(showtime.id);
                    }

                    if (!showDetails) {
                        console.warn(`Could not fetch details for show ID ${showtime.id}, type ${showtime.media_type}. Skipping.`);
                        continue;
                    }

                    const title = showDetails.title || showDetails.name;
                    const posterPath = showDetails.poster_path ? `${TMDB_IMAGE_BASE_URL}${POSTER_SIZE}${showDetails.poster_path}` : 'https://placehold.co/300x420/333/fff?text=No+Poster';
                    const releaseDate = showDetails.release_date || showDetails.first_air_date;
                    const year = releaseDate ? new Date(releaseDate).getFullYear() : 'N/A';
                    const rating = showDetails.vote_average ? showDetails.vote_average.toFixed(1) : 'N/A';
                    const genres = showDetails.genres ? showDetails.genres.map(g => g.name).join(', ') : '';

                    let episodeInfo = '';
                    if (showtime.isSeries && showtime.season && showtime.episode) {
                         // Attempt to get episode name if available (requires another API call to specific episode details)
                        // For simplicity here, we just use Season X, Episode Y
                        episodeInfo = `<p class="show-card-cinema-episode-info">Season ${showtime.season}, Episode ${showtime.episode}</p>`;
                    }

                    let networkLogoHtml = '';
                    if (showtime.media_type === 'tv' && showDetails.networks && showDetails.networks.length > 0) {
                        const networkLogoPath = showDetails.networks[0].logo_path;
                        if (networkLogoPath) {
                            networkLogoHtml = `<img src="${TMDB_IMAGE_BASE_URL}${LOGO_SIZE}${networkLogoPath}" alt="${showDetails.networks[0].name} Logo" class="network-logo" onerror="this.onerror=null;this.src='https://placehold.co/60x60/333/fff?text=${showDetails.networks[0].name.charAt(0)}';">`;
                        }
                    }

                    const showCardHtml = `
                        <div class="show-card-cinema" data-show-id="${showDetails.id}" data-media-type="${showtime.media_type}" data-cinema-name="${hall.name}" data-city="${cityName}" data-show-time="${showtime.time}" data-ticket-price="${showtime.price}">
                            <div class="show-card-cinema-poster-container">
                                <img src="${posterPath}" alt="${title} Poster" class="show-card-cinema-poster" onerror="this.onerror=null;this.src='https://placehold.co/300x420/333/fff?text=No+Poster';">
                                ${networkLogoHtml}
                            </div>
                            <div class="show-card-cinema-details">
                                <h3 class="show-card-cinema-title">${title}</h3>
                                <p class="show-card-cinema-meta">
                                    ${genres} | ${year} | <i class="fas fa-star"></i> ${rating}
                                </p>
                                ${episodeInfo}
                                <button class="buy-ticket-btn"><i class="fas fa-ticket-alt"></i> Buy Ticket (KES ${showtime.price})</button>
                            </div>
                        </div>
                    `;
                    showsGrid.insertAdjacentHTML('beforeend', showCardHtml);
                    contentGenerated = true;
                }
                if (showsGrid.children.length > 0) { // Only append hall section if it contains shows
                    container.appendChild(hallSection);
                }
            }
        }

        if (!contentGenerated) {
            container.innerHTML = '<p style="text-align: center; margin-top: 20px;">No shows available for the selected city.</p>';
        }

        // Add event listeners to "Buy Ticket" buttons AFTER content is rendered
        document.querySelectorAll('.buy-ticket-btn').forEach(button => {
            button.addEventListener('click', async (event) => {
                const card = event.target.closest('.show-card-cinema');
                const showId = parseInt(card.dataset.showId);
                const mediaType = card.dataset.mediaType;
                const cinemaName = card.dataset.cinemaName;
                const city = card.dataset.city;
                const showTime = card.dataset.showTime;
                const ticketPrice = parseFloat(card.dataset.ticketPrice);

                let selectedShowDetails = null;
                if (mediaType === 'movie') {
                    selectedShowDetails = await fetchMovieDetails(showId);
                } else if (mediaType === 'tv') {
                    selectedShowDetails = await fetchTvShowDetails(showId);
                }

                if (!selectedShowDetails) {
                    showMessageBox("Could not load show details for booking. Please try again.", "fas fa-exclamation-circle orange-icon");
                    return;
                }

                const selectedCinemaHall = cinemaData[city].find(hall => hall.name === cinemaName);
                const selectedShowtimeDetails = selectedCinemaHall.shows.find(s => s.id === showId && s.time === showTime);


                currentBooking.showDetails = selectedShowDetails;
                currentBooking.cinemaHall = selectedCinemaHall;
                currentBooking.city = city;
                currentBooking.showtimeDetails = selectedShowtimeDetails; // Store for seat data
                currentBooking.totalPrice = ticketPrice; // Initial price
                currentBooking.selectedSeat = null; // Reset selected seat
                currentBooking.snacks = []; // Reset snacks when starting new booking

                openBookingModal(); // Open modal with pre-fetched details
            });
        });
    }

    // --- Hero section dynamic text and background cycling ---
    const cinemaHero = document.getElementById('cinemaHero');
    const heroContentCinema = document.getElementById('heroContentCinema');
    let currentHeroBackdropIndex = 0;

    /**
     * Updates the hero section background with a rotating TMDB backdrop.
     */
    async function updateHeroBackgroundAndInfo() {
        // If we don't have enough backdrops, fetch more
        if (heroBackdrops.length < MAX_HERO_BACKDROPS) {
            try {
                const response = await fetch(`${TMDB_BASE_URL}/trending/all/week?api_key=${TMDB_API_KEY}&language=en-US`);
                if (response.ok) {
                    const data = await response.json();
                    const newBackdrops = data.results
                        .filter(item => item.backdrop_path)
                        .map(item => `${TMDB_IMAGE_BASE_URL}${BACKDROP_SIZE}${item.backdrop_path}`);

                    // Add new unique backdrops until MAX_HERO_BACKDROPS is reached
                    newBackdrops.forEach(backdropUrl => {
                        if (heroBackdrops.length < MAX_HERO_BACKDROPS && !heroBackdrops.includes(backdropUrl)) {
                            heroBackdrops.push(backdropUrl);
                        }
                    });
                } else {
                    console.warn(`Could not fetch trending content for hero. Status: ${response.status}`);
                }
            } catch (error) {
                console.error("Error fetching hero backdrops:", error);
            }
        }

        if (heroBackdrops.length > 0) {
            const nextBackdrop = heroBackdrops[currentHeroBackdropIndex];
            if (cinemaHero) {
                cinemaHero.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url(${nextBackdrop})`;
            }
            currentHeroBackdropIndex = (currentHeroBackdropIndex + 1) % heroBackdrops.length;
        } else {
             // Fallback if no valid backdrops are found
            if (cinemaHero) {
                cinemaHero.style.backgroundImage = `linear-gradient(rgba(0,0,0,0.6), rgba(0,0,0,0.8)), url('https://placehold.co/1280x300/333/fff?text=CineWatch+Cinemas')`;
            }
        }
    }


    // --- Booking Modal Logic ---
    const bookingModal = document.getElementById('bookingModal');
    const closeBookingModalBtn = document.getElementById('closeBookingModal');
    const stepperProgressItems = document.querySelectorAll('.step-item');
    const bookingSteps = document.querySelectorAll('.booking-step');
    let currentStep = 0;

    // Elements for price display
    const priceDisplay = document.getElementById('priceDisplay');
    const summaryTotalPriceSpan = document.getElementById('summaryTotalPrice');

    // Stepper navigation buttons
    const proceedToPurchaseBtn = document.getElementById('proceedToPurchase');
    const nextStep1Btn = document.getElementById('nextStep1');
    const prevStep2Btn = document.getElementById('prevStep2');
    const nextStep2Btn = document.getElementById('nextStep2');
    const prevStep3Btn = document.getElementById('prevStep3');
    const nextStep3Btn = document.getElementById('nextStep3');
    const prevStep4Btn = document.getElementById('prevStep4');
    const nextStep4Btn = document.getElementById('nextStep4');
    const prevStep5Btn = document.getElementById('prevStep5');
    const confirmPaymentBtn = document.getElementById('confirmPaymentBtn');


    function openBookingModal() {
        const show = currentBooking.showDetails;
        // Populate Step 0 (Show Details Confirmation)
        document.getElementById('summaryShowPoster').src = show.poster_path ? `${TMDB_IMAGE_BASE_URL}${POSTER_SIZE}${show.poster_path}` : 'https://placehold.co/180x252/333/fff?text=No+Poster';
        document.getElementById('summaryShowPoster').alt = `${show.title || show.name} Poster`;
        document.getElementById('summaryShowTitle').textContent = show.title || show.name;
        document.getElementById('summaryShowGenre').textContent = show.genres ? show.genres.map(g => g.name).join(', ') : 'N/A';
        const releaseDate = show.release_date || show.first_air_date;
        document.getElementById('summaryShowYear').textContent = releaseDate ? new Date(releaseDate).getFullYear() : 'N/A';
        document.getElementById('summaryShowRating').innerHTML = show.vote_average ? `<i class="fas fa-star"></i> ${show.vote_average.toFixed(1)}` : 'N/A';
        document.getElementById('summaryShowDescription').textContent = show.overview || 'No description available.';
        
        // Fetch cast for summary
        fetchCastForSummary(show.id, show.media_type);


        // Set hero background of the modal to the show's backdrop
        bookingModal.querySelector('.booking-content').style.backgroundImage = `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.9)), url(${show.backdrop_path ? `${TMDB_IMAGE_BASE_URL}${BACKDROP_SIZE}${show.backdrop_path}` : 'https://placehold.co/1280x720/333/fff?text=No+Backdrop'})`;
        bookingModal.querySelector('.booking-content').style.backgroundSize = 'cover';
        bookingModal.querySelector('.booking-content').style.backgroundPosition = 'center';
        bookingModal.querySelector('.booking-content').style.color = 'white'; // Ensure text color is visible

        bookingModal.classList.add('show');
        currentStep = 0; // Always start from step 0
        updateStepper(0);
        showStep(0);
    }

    /**
     * Fetches and displays the main cast for the summary.
     * @param {number} showId - The ID of the movie or TV show.
     * @param {string} mediaType - 'movie' or 'tv'.
     */
    async function fetchCastForSummary(showId, mediaType) {
        const castElement = document.getElementById('summaryShowCast');
        if (!castElement) return;

        let castList = 'N/A';
        try {
            const url = `${TMDB_BASE_URL}/${mediaType}/${showId}/credits?api_key=${TMDB_API_KEY}`;
            const response = await fetch(url);
            if (response.ok) {
                const data = await response.json();
                if (data.cast && data.cast.length > 0) {
                    castList = data.cast.slice(0, 5).map(person => person.name).join(', '); // Top 5 cast members
                }
            } else {
                console.warn(`Could not fetch cast for ${mediaType} ${showId}. Status: ${response.status}`);
            }
        } catch (error) {
            console.error(`Error fetching cast for ${mediaType} ${showId}:`, error);
        }
        castElement.textContent = castList;
    }


    closeBookingModalBtn.addEventListener('click', () => {
        bookingModal.classList.remove('show');
        resetBookingModal();
    });

    function showStep(stepIndex) {
        bookingSteps.forEach((step, index) => {
            step.style.display = index === stepIndex ? 'block' : 'none';
        });
        updateStepper(stepIndex);
        updatePriceDisplay(); // Update price whenever step changes
        checkStepCompletion(stepIndex);
    }

    function updateStepper(activeStepIndex) {
        stepperProgressItems.forEach((item, index) => {
            item.classList.remove('active', 'completed');
            if (index === activeStepIndex) {
                item.classList.add('active');
            } else if (index < activeStepIndex) {
                item.classList.add('completed');
            }
        });
    }

    function resetBookingModal() {
        currentStep = 0;
        currentBooking = {
            showDetails: null, cinemaHall: null, city: null, selectedSeat: null,
            snacks: [], cabService: { needed: false, pickupType: 'home', address: '', cabStand: '' },
            totalPrice: 0, selectedPaymentMethod: null
        };

        // Reset all steps to initial state
        document.getElementById('seatsGrid').innerHTML = ''; // Clear seats
        document.getElementById('noSnacks').checked = true; // Reset snacks radio
        document.querySelectorAll('.snack-qty').forEach(input => {
            input.value = 0;
            input.disabled = true; // Disable snack quantity inputs
        });
        document.getElementById('noCabService').checked = true; // Reset cab
        document.getElementById('cabDetails').style.display = 'none';
        document.getElementById('homeAddressInput').value = '';
        document.getElementById('homeAddressInput').disabled = false;
        document.getElementById('cabStandSelect').innerHTML = '<option value="">Select a cab stand</option>';
        document.getElementById('cabStandSelect').disabled = true;
        document.getElementById('pickupHome').checked = true;

        document.querySelectorAll('.payment-method-item').forEach(item => item.classList.remove('selected'));
        confirmPaymentBtn.disabled = true;

        updateStepper(0);
        showStep(0);
    }

    function updatePriceDisplay() {
        priceDisplay.textContent = `Total Price: KES ${currentBooking.totalPrice.toFixed(2)}`;
        summaryTotalPriceSpan.textContent = currentBooking.totalPrice.toFixed(2);
    }

    function checkStepCompletion(step) {
        if (step === 1) { // Seat selection step
            nextStep1Btn.disabled = !currentBooking.selectedSeat;
        } else if (step === 3) { // Cab service step
            // Cab button enable logic: if cab needed, either address or cab stand must be selected. If not needed, always enabled.
            const cabNeeded = document.getElementById('yesCabService').checked;
            let cabReady = true;
            if (cabNeeded) {
                const pickupHome = document.getElementById('pickupHome').checked;
                const pickupCabStand = document.getElementById('pickupCabStand').checked;

                if (pickupHome && homeAddressInput.value.trim() === '') {
                    cabReady = false;
                } else if (pickupCabStand && cabStandSelect.value === '') {
                    cabReady = false;
                }
            }
            nextStep3Btn.disabled = !cabReady;
        } else if (step === 5) { // Payment step
            confirmPaymentBtn.disabled = !currentBooking.selectedPaymentMethod;
        }
    }


    // Stepper Navigation Handlers
    proceedToPurchaseBtn.addEventListener('click', () => {
        currentStep = 1;
        showStep(currentStep);
        renderSeats(); // Render seats for the selected show
    });

    nextStep1Btn.addEventListener('click', () => {
        if (currentBooking.selectedSeat) {
            currentStep = 2;
            showStep(currentStep);
            renderSnacks(); // Render snacks for the step
            updateSnacksInputsState(); // Ensure inputs are enabled/disabled correctly on step entry
        } else {
            showMessageBox("Please select a seat to proceed!", "fas fa-exclamation-circle orange-icon");
        }
    });

    prevStep2Btn.addEventListener('click', () => {
        currentStep = 1;
        showStep(currentStep);
    });
    nextStep2Btn.addEventListener('click', () => {
        currentStep = 3;
        showStep(currentStep);
        updateCabOptions(); // Load cab options based on selected cinema/city
    });

    prevStep3Btn.addEventListener('click', () => {
        currentStep = 2;
        showStep(currentStep);
    });
    nextStep3Btn.addEventListener('click', () => {
        if (!nextStep3Btn.disabled) { // Only proceed if validation passes
            currentStep = 4;
            showStep(currentStep);
            updateSummary(); // Populate summary details
        }
    });

    prevStep4Btn.addEventListener('click', () => {
        currentStep = 3;
        showStep(currentStep);
    });
    nextStep4Btn.addEventListener('click', () => {
        currentStep = 5;
        showStep(currentStep);
    });

    prevStep5Btn.addEventListener('click', () => {
        currentStep = 4;
        showStep(currentStep);
    });

    confirmPaymentBtn.addEventListener('click', () => {
        if (currentBooking.selectedPaymentMethod) {
            const welcomeMessage = currentBooking.cinemaHall.welcomeMessage || "Enjoy your show!";
            showMessageBox(`Payment successful via ${currentBooking.selectedPaymentMethod}! ${welcomeMessage}`, "fas fa-check-circle green-icon");
            setTimeout(() => {
                bookingModal.classList.remove('show');
                resetBookingModal();
                // Optionally refresh cinema guide or redirect to home
                // window.location.reload();
            }, 3000); // Close modal and reset after 3 seconds
        } else {
            showMessageBox("Please select a payment method!", "fas fa-exclamation-triangle orange-icon");
        }
    });

    // --- Seat Selection (Step 1) ---
    const seatsGrid = document.getElementById('seatsGrid');
    const seatPrice = 100; // Base price per seat (example)

    function renderSeats() {
        seatsGrid.innerHTML = '';
        const showtimeDetails = currentBooking.showtimeDetails;
        if (!showtimeDetails || !showtimeDetails.seats) {
            seatsGrid.innerHTML = '<p>Seating information not available.</p>';
            return;
        }

        showtimeDetails.seats.forEach(seat => {
            const seatDiv = document.createElement('div');
            seatDiv.classList.add('seat');
            seatDiv.textContent = seat.id;
            seatDiv.dataset.seatId = seat.id;

            if (seat.occupied) {
                seatDiv.classList.add('occupied');
            } else {
                seatDiv.addEventListener('click', () => {
                    // Deselect previous seat
                    const previouslySelected = seatsGrid.querySelector('.seat.selected');
                    if (previouslySelected && previouslySelected !== seatDiv) {
                        previouslySelected.classList.remove('selected');
                        // No change to total price for initial seat selection
                    }

                    // Select current seat
                    seatDiv.classList.toggle('selected');
                    if (seatDiv.classList.contains('selected')) {
                        currentBooking.selectedSeat = seat.id;
                        currentBooking.totalPrice = currentBooking.showtimeDetails.price; // Base ticket price
                    } else {
                        currentBooking.selectedSeat = null;
                        currentBooking.totalPrice = currentBooking.showtimeDetails.price; // Reset to base ticket price if no seat selected
                    }
                    updatePriceDisplay();
                    checkStepCompletion(1); // Check if next button should be enabled
                });
            }
            seatsGrid.appendChild(seatDiv);
        });

        // Ensure the next button is initially disabled if no seat is selected
        nextStep1Btn.disabled = !currentBooking.selectedSeat;
        updatePriceDisplay(); // Initial price display
    }

    // --- Snacks Selection (Step 2) ---
    const snacksContainer = document.getElementById('snacksContainer');
    const yesSnacksRadio = document.getElementById('yesSnacks');
    const noSnacksRadio = document.getElementById('noSnacks');


    function renderSnacks() {
        snacksContainer.innerHTML = '';
        snacksData.forEach(snack => {
            const snackItem = document.createElement('div');
            snackItem.classList.add('snack-item');
            snackItem.innerHTML = `
                <img src="${snack.image}" alt="${snack.name}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/333/fff?text=Snack';">
                <label>${snack.name}</label>
                <p>KES ${snack.price.toFixed(2)}</p>
                <input type="number" class="snack-qty" data-snack-name="${snack.name}" data-snack-price="${snack.price}" value="0" min="0">
            `;
            snacksContainer.appendChild(snackItem);
        });

        // Event listener for quantity changes
        document.querySelectorAll('.snack-qty').forEach(input => {
            input.addEventListener('change', updateSnacksSelection);
            input.addEventListener('input', updateSnacksSelection); // Also listen to input
        });

        // Event listeners for "Yes/No" snacks radio buttons
        yesSnacksRadio.addEventListener('change', updateSnacksInputsState);
        noSnacksRadio.addEventListener('change', updateSnacksInputsState);

        // Initial update of snacks and price
        updateSnacksSelection();
        updateSnacksInputsState(); // Set initial state of inputs
    }

    function updateSnacksInputsState() {
        const snackQuantities = document.querySelectorAll('.snack-qty');
        if (noSnacksRadio.checked) {
            snackQuantities.forEach(input => {
                input.value = 0; // Reset quantities
                input.disabled = true; // Disable inputs
            });
            currentBooking.snacks = []; // Clear selected snacks
        } else {
            snackQuantities.forEach(input => {
                input.disabled = false; // Enable inputs
            });
        }
        updateSnacksSelection(); // Recalculate price based on the state change
    }

    function updateSnacksSelection() {
        currentBooking.snacks = [];
        let snacksCost = 0;

        if (yesSnacksRadio.checked) { // Only calculate if "Yes" is selected
            document.querySelectorAll('.snack-qty').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    const name = input.dataset.snackName;
                    const price = parseFloat(input.dataset.snackPrice);
                    currentBooking.snacks.push({ name: name, qty: qty, price: price });
                    snacksCost += qty * price;
                }
            });
        }
        // Recalculate total price: Base ticket price + snacks cost
        // Ensure currentBooking.showtimeDetails is not null, fallback to 0 if not set yet
        const baseTicketPrice = currentBooking.showtimeDetails ? currentBooking.showtimeDetails.price : 0;
        currentBooking.totalPrice = baseTicketPrice + snacksCost;
        updatePriceDisplay();
    }


    // --- Cab Service (Step 3) ---
    const noCabServiceRadio = document.getElementById('noCabService');
    const yesCabServiceRadio = document.getElementById('yesCabService');
    const cabDetailsDiv = document.getElementById('cabDetails');
    const pickupHomeRadio = document.getElementById('pickupHome');
    const pickupCabStandRadio = document.getElementById('pickupCabStand');
    const homeAddressInput = document.getElementById('homeAddressInput');
    const cabStandSelect = document.getElementById('cabStandSelect');

    function updateCabOptions() {
        const city = currentBooking.city;

        // Reset inputs and selection
        homeAddressInput.value = '';
        cabStandSelect.innerHTML = '<option value="">Select a cab stand</option>';

        // Reset cab service in currentBooking
        currentBooking.cabService = { needed: false, pickupType: 'home', address: '', cabStand: '' };

        if (yesCabServiceRadio.checked) {
            cabDetailsDiv.style.display = 'block';
            pickupHomeRadio.checked = true; // Default to home pickup
            homeAddressInput.disabled = false; // Enable home address input
            cabStandSelect.disabled = true; // Disable cab stand select

            currentBooking.cabService.needed = true;
            currentBooking.cabService.pickupType = 'home';

            // Populate cab stands based on cinema's city
            if (city && cabServiceData) {
                // Find all unique cab stands for the current city across all providers
                let cityCabStands = new Set();
                for (const provider in cabServiceData) {
                    if (cabServiceData[provider].locations[city]) {
                        cabServiceData[provider].locations[city].forEach(stand => cityCabStands.add(stand));
                    }
                }
                Array.from(cityCabStands).sort().forEach(stand => {
                    const option = document.createElement('option');
                    option.value = stand;
                    option.textContent = stand;
                    cabStandSelect.appendChild(option);
                });
            }

        } else {
            cabDetailsDiv.style.display = 'none';
            currentBooking.cabService.needed = false;
        }
        checkStepCompletion(3); // Update next button
    }

    noCabServiceRadio.addEventListener('change', updateCabOptions);
    yesCabServiceRadio.addEventListener('change', updateCabOptions);

    pickupHomeRadio.addEventListener('change', () => {
        homeAddressInput.disabled = false;
        cabStandSelect.disabled = true;
        cabStandSelect.value = ''; // Clear selected cab stand
        currentBooking.cabService.pickupType = 'home';
        currentBooking.cabService.cabStand = '';
        checkStepCompletion(3);
    });

    pickupCabStandRadio.addEventListener('change', () => {
        homeAddressInput.disabled = true;
        homeAddressInput.value = ''; // Clear home address
        cabStandSelect.disabled = false;
        currentBooking.cabService.pickupType = 'cab_stand';
        currentBooking.cabService.address = '';
        checkStepCompletion(3);
    });

    homeAddressInput.addEventListener('input', () => {
        currentBooking.cabService.address = homeAddressInput.value.trim();
        checkStepCompletion(3);
    });

    cabStandSelect.addEventListener('change', () => {
        currentBooking.cabService.cabStand = cabStandSelect.value;
        checkStepCompletion(3);
    });

    // Initial check for cab service step on load (or when step 3 is shown)
    // This is handled by checkStepCompletion(3) which is called in updateCabOptions()

    // --- Summary (Step 4) ---
    function updateSummary() {
        document.getElementById('summaryShowName').textContent = currentBooking.showDetails ? (currentBooking.showDetails.title || currentBooking.showDetails.name) : 'N/A';
        document.getElementById('summaryCinemaHall').textContent = currentBooking.cinemaHall ? currentBooking.cinemaHall.name : 'N/A';
        document.getElementById('summaryCity').textContent = currentBooking.city || 'N/A';
        document.getElementById('summarySeat').textContent = currentBooking.selectedSeat || 'None selected';

        let snacksSummary = "None";
        if (currentBooking.snacks.length > 0) {
            snacksSummary = currentBooking.snacks.map(s => `${s.qty}x ${s.name}`).join(', ');
        }
        document.getElementById('summarySnacks').textContent = snacksSummary;

        let cabSummary = "Not needed";
        if (yesCabServiceRadio.checked) {
            if (pickupHomeRadio.checked && homeAddressInput.value) {
                cabSummary = `Home: ${homeAddressInput.value}`;
            } else if (pickupCabStandRadio.checked && cabStandSelect.value) {
                cabSummary = `Cab Stand: ${cabStandSelect.value}`;
            } else {
                cabSummary = "Cab service selected, but no details provided.";
            }
        }
        document.getElementById('summaryCabService').textContent = cabSummary;

        updatePriceDisplay(); // Ensures total price is updated
    }

    // --- Payment (Step 5) ---
    document.querySelectorAll('.payment-method-item').forEach(item => {
        item.addEventListener('click', () => {
            document.querySelectorAll('.payment-method-item').forEach(p => p.classList.remove('selected'));
            item.classList.add('selected');
            currentBooking.selectedPaymentMethod = item.dataset.method;
            checkStepCompletion(5); // Enable confirm button
        });
    });


    // --- Event Listeners and Initial Page Load Logic ---

    document.addEventListener("DOMContentLoaded", async () => {
        // --- Initial Loading Screen Animation ---
        setTimeout(() => {
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                // Remove loading screen from DOM after transition
                loadingScreen.addEventListener('transitionend', () => loadingScreen.remove());
            }
        }, 3000); // 3 seconds loading

        // --- Cinema Hero Background Cycling ---
        // Initial update and start cycling
        await updateHeroBackgroundAndInfo(); // Await first fetch to populate backdrops
        setInterval(updateHeroBackgroundAndInfo, 5000); // Change every 5 seconds

        // --- Header/Footer/Search/Mobile Nav Logic ---
        const searchToggleButton = document.getElementById('searchToggleButton');
        const dynamicSearchArea = document.getElementById('dynamicSearchArea');
        const expandedSearchBar = document.getElementById('expandedSearchBar');
        const micIconBtn = document.getElementById('micIconBtn');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const searchActionBtn = document.getElementById('searchActionBtn');
        const genreFilter = document.getElementById('genreFilter');
        const yearFilter = document.getElementById('yearFilter');
        const searchSuggestionsContainer = document.getElementById('searchSuggestionsContainer');

        const accountButton = document.getElementById('accountButton');
        const accountDropdown = document.getElementById('accountDropdown');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mobileNavLinks = document.getElementById('mobileNavLinks');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const desktopLogoutLink = document.getElementById('desktopLogoutLink');
        const mobileLogoutLink = document.getElementById('mobileLogoutLink');

        // Toggles Account Dropdown
        if (accountButton && accountDropdown) {
            accountButton.addEventListener('click', (e) => {
                e.stopPropagation();
                accountDropdown.classList.toggle('show');
            });
            document.addEventListener('click', (e) => {
                if (!accountDropdown.contains(e.target) && !accountButton.contains(e.target)) {
                    accountDropdown.classList.remove('show');
                }
                // Hide search suggestions if clicked outside
                if (searchSuggestionsContainer && !expandedSearchBar.contains(e.target) && !searchSuggestionsContainer.contains(e.target)) {
                    searchSuggestionsContainer.classList.remove('show');
                }
            });
        }

        // Toggles Mobile Menu
        if (mobileMenuToggle && mobileNavLinks) {
            mobileMenuToggle.addEventListener('click', () => {
                mobileNavLinks.classList.toggle('show-mobile-menu');
            });
        }

        // Toggles Dark Mode
        if (darkModeToggle) {
            darkModeToggle.addEventListener('click', toggleDarkMode);
        }

        // Handles Logout functionality (simulated)
        const performLogout = () => {
            showMessageBox('You have been logged out.', 'fas fa-check-circle green-icon');
            updateAccountDropdown(false);
            // Close mobile menu if open after logout
            if (mobileNavLinks) {
                mobileNavLinks.classList.remove('show-mobile-menu');
            }
        };

        if (desktopLogoutLink) {
            desktopLogoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                performLogout();
            });
        }
        if (mobileLogoutLink) {
            mobileLogoutLink.addEventListener('click', (e) => {
                e.preventDefault();
                performLogout();
            });
        }

        // Initializes Dark Mode based on localStorage
        const storedTheme = localStorage.getItem('theme'); // Corrected: This is the first declaration
        if (storedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            if (darkModeToggle) {
                darkModeToggle.querySelector('i').classList.replace('fa-moon', 'fa-sun');
                darkModeToggle.setAttribute('aria-label', 'Toggle Light Mode');
                darkModeToggle.setAttribute('title', 'Toggle Light Mode');
            }
        }
        updateAccountDropdown(false); // Default to logged out

        // Updates the current year in the footer
        const currentYearSpan = document.getElementById('current-year');
        if (currentYearSpan) {
            currentYearSpan.textContent = new Date().getFullYear();
        }

        // Sets Last Modified Date in footer
        const lastModifiedSpan = document.getElementById('last-modified');
        if (lastModifiedSpan) {
            lastModifiedSpan.textContent = new Date(document.lastModified).toLocaleDateString();
        }

        // Handles Dynamic Search Bar Logic
        if (searchToggleButton && dynamicSearchArea && expandedSearchBar && searchActionBtn) {
            searchToggleButton.addEventListener('click', () => {
                const isShowing = dynamicSearchArea.classList.toggle('show');
                if (isShowing) {
                    expandedSearchBar.focus();
                } else {
                    // When hiding, also hide suggestions
                    if (searchSuggestionsContainer) searchSuggestionsContainer.classList.remove('show');
                }
            });

            // Debounced search input for suggestions
            const debouncedSearch = debounce(async (query) => {
                const results = await fetchSearchResults(query);
                displaySearchResults(results);
            }, 300); // 300ms debounce delay

            expandedSearchBar.addEventListener('input', () => {
                const query = expandedSearchBar.value.trim();
                if (query.length > 2) { // Start suggesting after 2 characters
                    debouncedSearch(query);
                } else {
                    if (searchSuggestionsContainer) searchSuggestionsContainer.classList.remove('show');
                }
                // Shows/hides searchActionBtn and manages clearSearchBtn based on input
                if (expandedSearchBar.value.length > 0) {
                    searchActionBtn.style.display = 'inline-block';
                    clearSearchBtn.style.display = 'inline-block';
                } else {
                    searchActionBtn.style.display = 'none';
                    clearSearchBtn.style.display = 'none';
                }
            });

            // Handles clear search button click
            clearSearchBtn.addEventListener('click', () => {
                expandedSearchBar.value = '';
                searchActionBtn.style.display = 'none';
                clearSearchBtn.style.display = 'none';
                if (searchSuggestionsContainer) searchSuggestionsContainer.classList.remove('show');
            });

            // Handles mic icon button click (placeholder)
            micIconBtn.addEventListener('click', () => {
                showMessageBox('Voice search activated. (Functionality not yet implemented)', 'fas fa-microphone blue-icon');
            });

            // Handles search action button click or Enter key press
            const performSearch = () => {
                const query = expandedSearchBar.value.trim();
                const genreId = genreFilter.value;
                const year = yearFilter.value;
                const cast = document.getElementById('castFilter').value.trim();

                if (query || genreId || year || cast) {
                    // In a real app, this would construct a more complex TMDB query
                    showMessageBox(`Searching for: "${query || 'All'}" (Genre: ${genreFilter.options[genreFilter.selectedIndex].text}, Year: ${year || 'All'}, Cast: ${cast || 'Any'})`, 'fas fa-search blue-icon');
                    if (searchSuggestionsContainer) searchSuggestionsContainer.classList.remove('show');
                } else {
                    showMessageBox('Please enter a search term or select filters.', 'fas fa-info-circle yellow-icon');
                }
            };

            searchActionBtn.addEventListener('click', performSearch);
            expandedSearchBar.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    performSearch();
                }
            });

            // Displays search results as suggestions in the search suggestions container.
            async function fetchSearchResults(query) {
                if (!query) return [];
                try {
                    const url = `${TMDB_BASE_URL}/search/multi?api_key=${TMDB_API_KEY}&language=en-US&query=${encodeURIComponent(query)}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    // Filter out results without a title/name, and media_type not useful for direct display (e.g., 'collection')
                    return data.results.filter(item =>
                        (item.media_type === 'movie' || item.media_type === 'tv' || item.media_type === 'person') &&
                        (item.title || item.name)
                    );
                } catch (error) {
                    console.error("Error fetching search results:", error);
                    return [];
                }
            }
            function displaySearchResults(results) {
                const searchSuggestionsContainer = document.getElementById('searchSuggestionsContainer');
                if (!searchSuggestionsContainer) return;

                searchSuggestionsContainer.innerHTML = ''; // Clear previous suggestions

                if (results.length > 0) {
                    results.slice(0, 5).forEach(item => { // Display top 5 suggestions
                        const suggestionItem = document.createElement('div');
                        suggestionItem.classList.add('search-suggestion-item');

                        const imagePath = item.poster_path ? `${TMDB_IMAGE_BASE_URL}w92${item.poster_path}` :
                                        (item.profile_path ? `${TMDB_IMAGE_BASE_URL}w92${item.profile_path}` :
                                        'https://placehold.co/92x138/cccccc/555555?text=No+Image'); // Fallback for profile/poster

                        const title = item.title || item.name;
                        let subtitle = '';
                        if (item.media_type === 'movie') {
                            subtitle = item.release_date ? `Movie (${new Date(item.release_date).getFullYear()})` : 'Movie';
                        } else if (item.media_type === 'tv') {
                            subtitle = item.first_air_date ? `TV Show (${new Date(item.first_air_date).getFullYear()})` : 'TV Show';
                        } else if (item.media_type === 'person') {
                            subtitle = item.known_for_department || 'Person';
                        }

                        suggestionItem.innerHTML = `
                            <img src="${imagePath}" alt="${title}" onerror="this.onerror=null; this.src='https://placehold.co/92x138/cccccc/555555?text=No+Image';">
                            <div class="search-suggestion-info">
                                <h4>${title}</h4>
                                <p>${subtitle}</p>
                            </div>
                        `;
                        searchSuggestionsContainer.appendChild(suggestionItem);

                        // Add click listener to fill search bar and potentially navigate
                        suggestionItem.addEventListener('click', () => {
                            document.getElementById('expandedSearchBar').value = title;
                            searchSuggestionsContainer.classList.remove('show');
                            showMessageBox(`Selected: ${title}. (Simulated navigation to details page)`, 'fas fa-info-circle blue-icon');
                            // In a real app, this would navigate to `details.html?id=${item.id}&type=${item.media_type}`;
                        });
                    });
                    searchSuggestionsContainer.classList.add('show'); // Show the container
                } else {
                    searchSuggestionsContainer.classList.remove('show'); // Hide if no results
                }
            }

            // Populates genres for the search bar filter
            async function fetchGenres(type) {
                const url = `${TMDB_BASE_URL}/genre/${type}/list?api_key=${TMDB_API_KEY}&language=en-US`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Could not fetch ${type} genres. Status: ${response.status}.`);
                        return [];
                    }
                    const data = await response.json();
                    return data.genres;
                } catch (error) {
                    console.warn(`Error fetching ${type} genres:`, error);
                    return [];
                }
            }
            function populateGenreFilter(selectElement, genres) {
                if (!selectElement) return;
                genres.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre.id;
                    option.textContent = genre.name;
                    selectElement.appendChild(option);
                });
            }
            function populateYearFilter(selectElement, startYear, endYear) {
                if (!selectElement) return;
                selectElement.innerHTML = '<option value="">All Years</option>'; // Clear existing options
                for (let year = endYear; year >= startYear; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    selectElement.appendChild(option);
                }
            }

            const currentYear = new Date().getFullYear();
            if (yearFilter) populateYearFilter(yearFilter, 1950, currentYear); // Years from 1950 to current

            // Fetch movie and TV genres and combine them for the general genre filter
            const movieGenres = await fetchGenres('movie');
            const tvGenres = await fetchGenres('tv');
            // Combine and unique genres (by ID)
            const allGenres = [...new Map([...movieGenres, ...tvGenres].map(genre => [genre.id, genre])).values()];
            if (genreFilter) populateGenreFilter(genreFilter, allGenres);
        }
        if (searchActionBtn) searchActionBtn.style.display = 'none';
        if (clearSearchBtn) clearSearchBtn.style.display = 'none';


        // --- Cinema Guide Page Initialization ---
        const citySelect = document.getElementById('citySelect');
        citySelect.addEventListener('change', (event) => {
            renderCinemaHalls(event.target.value);
        });

        // Initial render of cinema halls (default to 'all' cities)
        renderCinemaHalls('all');

        // Placeholder functions for global utilities (if not already defined elsewhere)
        function showMessageBox(message, iconClass) {
            const customAlert = document.getElementById('customAlert');
            const alertMessage = document.getElementById('alertMessage');
            const alertIcon = customAlert.querySelector('.alert-icon');
            
            alertMessage.textContent = message;
            alertIcon.className = `alert-icon ${iconClass}`; // Update icon class
            
            customAlert.classList.add('show');
            
            const closeAlertBtn = document.getElementById('closeAlertBtn');
            const closeHandler = () => {
                customAlert.classList.remove('show');
                closeAlertBtn.removeEventListener('click', closeHandler);
            };
            closeAlertBtn.addEventListener('click', closeHandler);
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const darkModeToggle = document.getElementById('darkModeToggle');
            const isDarkMode = document.body.classList.contains('dark-mode');
            if (darkModeToggle) {
                darkModeToggle.querySelector('i').classList.replace(isDarkMode ? 'fa-moon' : 'fa-sun', isDarkMode ? 'fa-sun' : 'fa-moon');
                darkModeToggle.setAttribute('aria-label', isDarkMode ? 'Toggle Light Mode' : 'Toggle Dark Mode');
                darkModeToggle.setAttribute('title', isDarkMode ? 'Toggle Light Mode' : 'Toggle Dark Mode');
            }
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        // Placeholder for updateAccountDropdown - assuming it updates visibility of login/logout links
        function updateAccountDropdown(isLoggedIn) {
            // This is a simplified simulation. In a real app, this would involve Firebase Auth state.
            const desktopLoginLink = document.getElementById('desktopLoginLink');
            const desktopRegisterLink = document.getElementById('desktopRegisterLink');
            const desktopProfileLink = document.getElementById('desktopProfileLink');
            const desktopSettingsLink = document.getElementById('desktopSettingsLink');
            const desktopWatchlistLink = document.getElementById('desktopWatchlistLink');
            const desktopHistoryLink = document.getElementById('desktopHistoryLink');
            const desktopLogoutLink = document.getElementById('desktopLogoutLink');

            const mobileLoginLink = document.getElementById('mobileLoginLink');
            const mobileRegisterLink = document.getElementById('mobileRegisterLink');
            const mobileProfileLink = document.getElementById('mobileProfileLink');
            const mobileSettingsLink = document.getElementById('mobileSettingsLink');
            const mobileWatchlistLink = document.getElementById('mobileWatchlistLink');
            const mobileHistoryLink = document.getElementById('mobileHistoryLink');
            const mobileLogoutLink = document.getElementById('mobileLogoutLink');


            if (isLoggedIn) {
                userLoggedIn = true;
                if (desktopLoginLink) desktopLoginLink.style.display = 'none';
                if (desktopRegisterLink) desktopRegisterLink.style.display = 'none';
                if (desktopProfileLink) desktopProfileLink.style.display = 'flex';
                if (desktopSettingsLink) desktopSettingsLink.style.display = 'flex';
                if (desktopWatchlistLink) desktopWatchlistLink.style.display = 'flex';
                if (desktopHistoryLink) desktopHistoryLink.style.display = 'flex';
                if (desktopLogoutLink) desktopLogoutLink.style.display = 'flex';

                if (mobileLoginLink) mobileLoginLink.style.display = 'none';
                if (mobileRegisterLink) mobileRegisterLink.style.display = 'none';
                if (mobileProfileLink) mobileProfileLink.style.display = 'flex';
                if (mobileSettingsLink) mobileSettingsLink.style.display = 'flex';
                if (mobileWatchlistLink) mobileWatchlistLink.style.display = 'flex';
                if (mobileHistoryLink) mobileHistoryLink.style.display = 'flex';
                if (mobileLogoutLink) mobileLogoutLink.style.display = 'flex';

            } else {
                userLoggedIn = false;
                if (desktopLoginLink) desktopLoginLink.style.display = 'flex';
                if (desktopRegisterLink) desktopRegisterLink.style.display = 'flex';
                if (desktopProfileLink) desktopProfileLink.style.display = 'none';
                if (desktopSettingsLink) desktopSettingsLink.style.display = 'none';
                if (desktopWatchlistLink) desktopWatchlistLink.style.display = 'none';
                if (desktopHistoryLink) desktopHistoryLink.style.display = 'none';
                if (desktopLogoutLink) desktopLogoutLink.style.display = 'none';

                if (mobileLoginLink) mobileLoginLink.style.display = 'flex';
                if (mobileRegisterLink) mobileRegisterLink.style.display = 'flex';
                if (mobileProfileLink) mobileProfileLink.style.display = 'none';
                if (mobileSettingsLink) mobileSettingsLink.style.display = 'none';
                if (mobileWatchlistLink) mobileWatchlistLink.style.display = 'none';
                if (mobileHistoryLink) mobileHistoryLink.style.display = 'none';
                if (mobileLogoutLink) mobileLogoutLink.style.display = 'none';
            }
        }

        // Placeholder for fetchActorFilmography - returns empty array for now
        async function fetchActorFilmography(personId, mediaType) {
            console.warn(`fetchActorFilmography(${personId}, ${mediaType}) called. This is a placeholder and does not fetch real data.`);
            return [];
        }
    });
  </script>
</body>
</html>
